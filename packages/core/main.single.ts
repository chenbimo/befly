// @bun
import{existsSync as X0}from"fs";var i0=!1,r0={NODE_ENV:"development",APP_NAME:i0?"\u91CE\u8702\u98DE\u821E\u6B63\u5F0F\u73AF\u5883":"\u91CE\u8702\u98DE\u821E\u5F00\u53D1\u73AF\u5883",APP_PORT:3000,APP_HOST:"127.0.0.1",DEV_EMAIL:"",DEV_PASSWORD:"123456",BODY_LIMIT:10485760,DATABASE_ENABLE:0,TZ:"Asia/Shanghai",LOG_DEBUG:1,LOG_EXCLUDE_FIELDS:"password,token,secret",LOG_DIR:"./logs",LOG_TO_CONSOLE:1,LOG_MAX_SIZE:10485760,DB_TYPE:"mysql",DB_HOST:"127.0.0.1",DB_PORT:3306,DB_USER:"root",DB_PASS:"root",DB_NAME:"befly_demo",DB_POOL_MAX:10,REDIS_HOST:"127.0.0.1",REDIS_PORT:6379,REDIS_USERNAME:"",REDIS_PASSWORD:"",REDIS_DB:0,REDIS_KEY_PREFIX:"befly_demo",JWT_SECRET:"befly-secret",JWT_EXPIRES_IN:"7d",JWT_ALGORITHM:"HS256",CORS_ALLOWED_ORIGIN:"*",CORS_ALLOWED_METHODS:"GET, POST, PUT, DELETE, OPTIONS",CORS_ALLOWED_HEADERS:"Content-Type, Authorization, authorization, token",CORS_EXPOSE_HEADERS:"Content-Range, X-Content-Range, Authorization, authorization, token",CORS_MAX_AGE:86400,CORS_ALLOW_CREDENTIALS:"true"};async function l0(){try{let $=process.cwd()+"/env.ts",z=process.cwd()+"/env.js",Z="";if(X0($))Z=$;else if(X0(z))Z=z;if(!Z)return{};let _=await import(Z);return _.Env||_.default||{}}catch($){return{}}}var a0=await l0(),M={...r0,...a0};var e0=/^[A-Za-z]:\//;function i($=""){if(!$)return $;return $.replace(/\\/g,"/").replace(e0,(z)=>z.toUpperCase())}var $$=/^[/\\]{2}/,z$=/^[/\\](?![/\\])|^[/\\]{2}(?!\.)|^[A-Za-z]:[/\\]/,M0=/^[A-Za-z]:$/,H0=/^\/([A-Za-z]:)?$/;var g=function($){if($.length===0)return".";$=i($);let z=$.match($$),Z=b($),_=$[$.length-1]==="/";if($=Z0($,!Z),$.length===0){if(Z)return"/";return _?"./":"."}if(_)$+="/";if(M0.test($))$+="/";if(z){if(!Z)return`//./${$}`;return`//${$}`}return Z&&!b($)?`/${$}`:$},R=function(...$){let z="";for(let Z of $){if(!Z)continue;if(z.length>0){let _=z[z.length-1]==="/",Q=Z[0]==="/";if(_&&Q)z+=Z.slice(1);else z+=_||Q?Z:`/${Z}`}else z+=Z}return g(z)};function Z$(){if(typeof process<"u"&&typeof process.cwd==="function")return process.cwd().replace(/\\/g,"/");return"/"}var z0=function(...$){$=$.map((_)=>i(_));let z="",Z=!1;for(let _=$.length-1;_>=-1&&!Z;_--){let Q=_>=0?$[_]:Z$();if(!Q||Q.length===0)continue;z=`${Q}/${z}`,Z=b(Q)}if(z=Z0(z,!Z),Z&&!b(z))return`/${z}`;return z.length>0?z:"."};function Z0($,z){let Z="",_=0,Q=-1,Y=0,U=null;for(let G=0;G<=$.length;++G){if(G<$.length)U=$[G];else if(U==="/")break;else U="/";if(U==="/"){if(Q===G-1||Y===1);else if(Y===2){if(Z.length<2||_!==2||Z[Z.length-1]!=="."||Z[Z.length-2]!=="."){if(Z.length>2){let A=Z.lastIndexOf("/");if(A===-1)Z="",_=0;else Z=Z.slice(0,A),_=Z.length-1-Z.lastIndexOf("/");Q=G,Y=0;continue}else if(Z.length>0){Z="",_=0,Q=G,Y=0;continue}}if(z)Z+=Z.length>0?"/..":"..",_=2}else{if(Z.length>0)Z+=`/${$.slice(Q+1,G)}`;else Z=$.slice(Q+1,G);_=G-Q-1}Q=G,Y=0}else if(U==="."&&Y!==-1)++Y;else Y=-1}return Z}var b=function($){return z$.test($)};var _0=function($,z){let Z=z0($).replace(H0,"$1").split("/"),_=z0(z).replace(H0,"$1").split("/");if(_[0][1]===":"&&Z[0][1]===":"&&Z[0]!==_[0])return _.join("/");let Q=[...Z];for(let Y of Q){if(_[0]!==Y)break;Z.shift(),_.shift()}return[...Z.map(()=>".."),..._].join("/")},Q0=function($){let z=i($).replace(/\/$/,"").split("/").slice(0,-1);if(z.length===1&&M0.test(z[0]))z[0]+="/";return z.join("/")||(b($)?"/":".")};var f=function($,z){let Z=i($).split("/"),_="";for(let Q=Z.length-1;Q>=0;Q--){let Y=Z[Q];if(Y){_=Y;break}}return z&&_.endsWith(z)?_.slice(0,-z.length):_};import{appendFile as _$,stat as O0}from"fs/promises";function Q$(){let $=new Date,z=$.getFullYear(),Z=String($.getMonth()+1).padStart(2,"0"),_=String($.getDate()).padStart(2,"0"),Q=String($.getHours()).padStart(2,"0"),Y=String($.getMinutes()).padStart(2,"0"),U=String($.getSeconds()).padStart(2,"0");return`${z}-${Z}-${_} ${Q}:${Y}:${U}`}class W{static currentFiles=new Map;static async log($,z){if($==="debug"&&M.LOG_DEBUG!==1)return;let Z=Q$(),_="";if(typeof z==="object"&&z!==null&&Object.keys(z).length>0)_=JSON.stringify(z,null,0).replace(/\\"/g,'"');else _=String(z);let Q=$.toUpperCase().padStart(5),Y=`[${Z}] ${Q} - ${_}`;if(M.LOG_TO_CONSOLE===1)console.log(Y);await this.writeToFile(Y,$)}static async success($){await this.log("info",$)}static async writeToFile($,z="info"){try{let Z=z==="debug"?"debug":new Date().toISOString().split("T")[0],_=this.currentFiles.get(Z);if(_)try{if((await O0(_)).size>=M.LOG_MAX_SIZE)this.currentFiles.delete(Z),_=void 0}catch{this.currentFiles.delete(Z),_=void 0}if(!_){let Q=new Bun.Glob(`${Z}.*.log`),Y=await Array.fromAsync(Q.scan(M.LOG_DIR||"logs")),U=(A)=>parseInt(A.match(/\.(\d+)\.log$/)?.[1]||"0");Y.sort((A,H)=>U(A)-U(H));let G=!1;for(let A=Y.length-1;A>=0;A--){let H=R(M.LOG_DIR||"logs",Y[A]);try{if((await O0(H)).size<M.LOG_MAX_SIZE){_=H,G=!0;break}}catch{continue}}if(!G){let A=Y.length>0?Math.max(...Y.map(U)):-1;_=R(M.LOG_DIR||"logs",`${Z}.${A+1}.log`)}this.currentFiles.set(Z,_)}await _$(_,$+`
`,"utf8")}catch(Z){console.error("\u5199\u5165\u65E5\u5FD7\u6587\u4EF6\u5931\u8D25:",Z?.message||Z)}}static async error($,z){if(!z)return this.log("error",$);let Z=[$];if(z?.message||z?.stack){if(z.message)Z.push(z.message);if(z.stack)Z.push(`
`+z.stack)}else{let _=typeof z==="object"?JSON.stringify(z):String(z);Z.push(_)}await this.log("error",Z.join(" - "))}static async warn($){await this.log("warn",$)}static async info($){await this.log("info",$)}static async debug($){await this.log("debug",$)}static clearCache(){this.currentFiles.clear()}static printEnv(){console.log("========================================"),console.log("\u5F00\u59CB\u6267\u884C\u5B8C\u6574\u540C\u6B65\u6D41\u7A0B"),console.log(`\u5F53\u524D\u73AF\u5883: ${M.NODE_ENV||"development"}`),console.log(`\u9879\u76EE\u540D\u79F0: ${M.APP_NAME}`),console.log(`\u6570\u636E\u5E93\u5730\u5740: ${M.DB_HOST}`),console.log(`\u6570\u636E\u5E93\u540D\u79F0: ${M.DB_NAME}`),console.log(`========================================
`)}}import{createSign as Y$}from"crypto";class J0{static md5($,z="hex"){let Z=new Bun.CryptoHasher("md5");return Z.update($),Z.digest(z)}static hmacMd5($,z,Z="hex"){let _=new Bun.CryptoHasher("md5",$);return _.update(z),_.digest(Z)}static sha1($,z="hex"){let Z=new Bun.CryptoHasher("sha1");return Z.update($),Z.digest(z)}static hmacSha1($,z,Z="hex"){let _=new Bun.CryptoHasher("sha1",$);return _.update(z),_.digest(Z)}static sha256($,z="hex"){let Z=new Bun.CryptoHasher("sha256");return Z.update($),Z.digest(z)}static rsaSha256($,z,Z="hex"){let _=Y$("RSA-SHA256");return _.update($),_.sign(z,Z)}static hmacSha256($,z,Z="hex"){let _=new Bun.CryptoHasher("sha256",$);return _.update(z),_.digest(Z)}static sha512($,z="hex"){let Z=new Bun.CryptoHasher("sha512");return Z.update($),Z.digest(z)}static hmacSha512($,z,Z="hex"){let _=new Bun.CryptoHasher("sha512",$);return _.update(z),_.digest(Z)}static hash($,z,Z="hex"){let _=new Bun.CryptoHasher($);return _.update(z),_.digest(Z)}static hmac($,z,Z,_="hex"){let Q=new Bun.CryptoHasher($,z);return Q.update(Z),Q.digest(_)}static async hashFile($,z="sha256",Z="hex"){let _=Bun.file($),Q=new Bun.CryptoHasher(z),U=_.stream().getReader();try{while(!0){let{done:G,value:A}=await U.read();if(G)break;Q.update(A)}return Q.digest(Z)}finally{U.releaseLock()}}static async hashPassword($,z={}){let Z={algorithm:"bcrypt",...z};return await Bun.password.hash($,Z)}static async verifyPassword($,z){return await Bun.password.verify($,z)}static base64Encode($){return Buffer.from($,"utf8").toString("base64")}static base64Decode($){return Buffer.from($,"base64").toString("utf8")}static randomString($){let z=Math.ceil($/2),Z=crypto.getRandomValues(new Uint8Array(z)),_="";for(let Q=0;Q<Z.length;Q++)_+=Z[Q].toString(16).padStart(2,"0");return _.slice(0,$)}static fastHash($,z=0){return Bun.hash($,z)}}import{createHmac as U$}from"crypto";class V{static ALGORITHMS={HS256:"sha256",HS384:"sha384",HS512:"sha512"};static base64UrlEncode($){return(Buffer.isBuffer($)?$.toString("base64"):Buffer.from($,"utf8").toString("base64")).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}static base64UrlDecode($){let z=4-$.length%4;if(z!==4)$+="=".repeat(z);return $=$.replace(/-/g,"+").replace(/_/g,"/"),Buffer.from($,"base64").toString("utf8")}static parseExpiration($){if(typeof $==="number")return $;if(typeof $!=="string")throw Error("\u8FC7\u671F\u65F6\u95F4\u683C\u5F0F\u65E0\u6548");let z=parseInt($);if(!isNaN(z)&&z.toString()===$)return z;let Z=$.match(/^(-?\d+)(ms|[smhdwy])$/);if(!Z)throw Error("\u8FC7\u671F\u65F6\u95F4\u683C\u5F0F\u65E0\u6548");let _=parseInt(Z[1]),Q=Z[2];if(Q==="ms")return Math.floor(_/1000);return _*{s:1,m:60,h:3600,d:86400,w:604800,y:31536000}[Q]}static createSignature($,z,Z){let _=this.ALGORITHMS[$];if(!_)throw Error(`\u4E0D\u652F\u6301\u7684\u7B97\u6CD5: ${$}`);let Q=U$(_,z);return Q.update(Z),this.base64UrlEncode(Q.digest())}static constantTimeCompare($,z){if($.length!==z.length)return!1;let Z=0;for(let _=0;_<$.length;_++)Z|=$.charCodeAt(_)^z.charCodeAt(_);return Z===0}static sign($,z){if(!$||typeof $!=="object")throw Error("\u8F7D\u8377\u5FC5\u987B\u662F\u975E\u7A7A\u5BF9\u8C61");let Z=z?.secret||M.JWT_SECRET;if(!Z)throw Error("JWT\u5BC6\u94A5\u672A\u914D\u7F6E");let _=z||{},Q=_.algorithm||M.JWT_ALGORITHM||"HS256",Y=Math.floor(Date.now()/1000),U=V.base64UrlEncode(JSON.stringify({alg:Q,typ:"JWT"})),G={...$,iat:Y};if(_.expiresIn){let K=V.parseExpiration(_.expiresIn);G.exp=Y+K}else{let K=M.JWT_EXPIRES_IN||"7d",O=V.parseExpiration(K);G.exp=Y+O}if(_.issuer)G.iss=_.issuer;if(_.audience)G.aud=_.audience;if(_.subject)G.sub=_.subject;if(_.notBefore)G.nbf=typeof _.notBefore==="number"?_.notBefore:Y+V.parseExpiration(_.notBefore);if(_.jwtId)G.jti=_.jwtId;let A=V.base64UrlEncode(JSON.stringify(G)),H=`${U}.${A}`,X=V.createSignature(Q,Z,H);return`${H}.${X}`}static verify($,z){if(!$||typeof $!=="string")throw Error("Token\u5FC5\u987B\u662F\u975E\u7A7A\u5B57\u7B26\u4E32");let Z=z?.secret||M.JWT_SECRET;if(!Z)throw Error("JWT\u5BC6\u94A5\u672A\u914D\u7F6E");let _=z||{},Q=$.split(".");if(Q.length!==3)throw Error("JWT\u683C\u5F0F\u65E0\u6548");try{let Y=JSON.parse(V.base64UrlDecode(Q[0])),U=JSON.parse(V.base64UrlDecode(Q[1])),G=Q[2];if(!V.ALGORITHMS[Y.alg])throw Error(`\u4E0D\u652F\u6301\u7684\u7B97\u6CD5: ${Y.alg}`);let A=`${Q[0]}.${Q[1]}`,H=V.createSignature(Y.alg,Z,A);if(!V.constantTimeCompare(G,H))throw Error("Token\u7B7E\u540D\u65E0\u6548");let X=Math.floor(Date.now()/1000);if(!_.ignoreExpiration&&U.exp&&U.exp<X)throw Error("Token\u5DF2\u8FC7\u671F (expired)");if(!_.ignoreNotBefore&&U.nbf&&U.nbf>X)throw Error("Token\u5C1A\u672A\u751F\u6548");if(_.issuer&&U.iss!==_.issuer)throw Error("Token\u53D1\u884C\u8005\u65E0\u6548");if(_.audience){if(!(Array.isArray(U.aud)?U.aud:[U.aud]).includes(_.audience))throw Error("Token\u53D7\u4F17\u65E0\u6548")}if(_.subject&&U.sub!==_.subject)throw Error("Token\u4E3B\u9898\u65E0\u6548");return U}catch(Y){if(Y.message.includes("JWT")||Y.message.includes("Token")||Y.message.includes("\u65E0\u6548")||Y.message.includes("\u8FC7\u671F")||Y.message.includes("\u4E0D\u652F\u6301"))throw Y;throw Error("Token\u9A8C\u8BC1\u5931\u8D25: "+Y.message)}}static decode($,z=!1){if(!$||typeof $!=="string")throw Error("Token\u5FC5\u987B\u662F\u975E\u7A7A\u5B57\u7B26\u4E32");let Z=$.split(".");if(Z.length!==3)throw Error("JWT\u683C\u5F0F\u65E0\u6548");try{let _=JSON.parse(V.base64UrlDecode(Z[0])),Q=JSON.parse(V.base64UrlDecode(Z[1]));return z?{header:_,payload:Q,signature:Z[2]}:Q}catch(_){throw Error("JWT\u89E3\u7801\u5931\u8D25: "+_.message)}}static getTimeToExpiry($){try{let z=this.decode($);if(!z.exp)return-1;let Z=z.exp-Math.floor(Date.now()/1000);return Z>0?Z:-1}catch{return-1}}static isExpired($){return this.getTimeToExpiry($)<=0}static isNearExpiry($,z=300){let Z=this.getTimeToExpiry($);return Z>0&&Z<=z}static hasRole($,z){if(!$)return!1;if($.role===z)return!0;if(Array.isArray($.roles)&&$.roles.includes(z))return!0;return!1}static hasAnyRole($,z){if(!$)return!1;return z.some((Z)=>this.hasRole($,Z))}static hasPermission($,z){if(!$||!$.permissions)return!1;return Array.isArray($.permissions)&&$.permissions.includes(z)}static hasAllPermissions($,z){if(!$||!$.permissions)return!1;return z.every((Z)=>this.hasPermission($,Z))}static create($){return this.sign($)}static check($){return this.verify($)}static parse($){return this.decode($)}static signUserToken($,z){return this.sign($,z)}static signAPIToken($,z){return this.sign($,{audience:"api",expiresIn:"1h",...z})}static signRefreshToken($,z){return this.sign($,{audience:"refresh",expiresIn:"30d",...z})}static signTempToken($,z){return this.sign($,{audience:"temporary",expiresIn:"15m",...z})}static verifyUserToken($,z){return this.verify($,z)}static verifyAPIToken($,z){return this.verify($,{audience:"api",...z})}static verifyRefreshToken($,z){return this.verify($,{audience:"refresh",...z})}static verifyTempToken($,z){return this.verify($,{audience:"temporary",...z})}static verifyWithPermissions($,z,Z){let _=this.verify($,Z);if(!_.permissions)throw Error("Token\u4E2D\u4E0D\u5305\u542B\u6743\u9650\u4FE1\u606F");if(!(Array.isArray(z)?z:[z]).every((U)=>_.permissions.includes(U)))throw Error("\u6743\u9650\u4E0D\u8DB3");return _}static verifyWithRoles($,z,Z){let _=this.verify($,Z);if(!_.role&&!_.roles)throw Error("Token\u4E2D\u4E0D\u5305\u542B\u89D2\u8272\u4FE1\u606F");let Q=_.roles||[_.role];if(!(Array.isArray(z)?z:[z]).some((G)=>Q.includes(G)))throw Error("\u89D2\u8272\u6743\u9650\u4E0D\u8DB3");return _}static verifySoft($,z){return this.verify($,{ignoreExpiration:!0,...z})}}var{SQL:P0,RedisClient:O$}=globalThis.Bun;function K0($){return $.charAt(0).toUpperCase()+$.slice(1).toLowerCase()}var G$=/\p{Lu}?\p{Ll}+|[0-9]+|\p{Lu}+(?!\p{Ll})|\p{Emoji_Presentation}|\p{Extended_Pictographic}|\p{L}+/gu;function r($){return Array.from($.match(G$)??[])}function D($){let z=r($);if(z.length===0)return"";let[Z,..._]=z;return`${Z.toLowerCase()}${_.map((Q)=>K0(Q)).join("")}`}function C($){return r($).map((Z)=>Z.toLowerCase()).join("_")}class T{_select=[];_from="";_where=[];_joins=[];_orderBy=[];_groupBy=[];_having=[];_limit=null;_offset=null;_params=[];reset(){return this._select=[],this._from="",this._where=[],this._joins=[],this._orderBy=[],this._groupBy=[],this._having=[],this._limit=null,this._offset=null,this._params=[],this}_escapeField($){if(typeof $!=="string")return $;if($=$.trim(),$==="*"||$.startsWith("`")||$.includes("("))return $;if($.toUpperCase().includes(" AS ")){let z=$.split(/\s+AS\s+/i),Z=z[0].trim(),_=z[1].trim();return`${this._escapeField(Z)} AS ${_}`}if($.includes("."))return $.split(".").map((Z)=>{if(Z=Z.trim(),Z==="*"||Z.startsWith("`"))return Z;return`\`${Z}\``}).join(".");return`\`${$}\``}_escapeTable($){if(typeof $!=="string")return $;if($=$.trim(),$.startsWith("`"))return $;if($.includes(" ")){let z=$.split(/\s+/);if(z.length===2){let Z=z[0].trim(),_=z[1].trim();return`\`${Z}\` ${_}`}else return $}return`\`${$}\``}_validateParam($){if($===void 0)throw Error("\u53C2\u6570\u503C\u4E0D\u80FD\u4E3A undefined")}_applyOperator($,z,Z){let _=this._escapeField($);switch(z){case"$ne":case"$not":this._validateParam(Z),this._where.push(`${_} != ?`),this._params.push(Z);break;case"$in":if(!Array.isArray(Z))throw Error(`$in \u64CD\u4F5C\u7B26\u7684\u503C\u5FC5\u987B\u662F\u6570\u7EC4 (operator: ${z})`);if(Z.length===0)throw Error("$in \u64CD\u4F5C\u7B26\u7684\u6570\u7EC4\u4E0D\u80FD\u4E3A\u7A7A\u3002\u63D0\u793A\uFF1A\u7A7A\u6570\u7EC4\u4F1A\u5BFC\u81F4\u67E5\u8BE2\u6C38\u8FDC\u4E0D\u5339\u914D\u4EFB\u4F55\u8BB0\u5F55\uFF0C\u8FD9\u901A\u5E38\u4E0D\u662F\u9884\u671F\u884C\u4E3A\u3002\u8BF7\u68C0\u67E5\u67E5\u8BE2\u6761\u4EF6\u6216\u79FB\u9664\u8BE5\u5B57\u6BB5\u3002");let Q=Z.map(()=>"?").join(",");this._where.push(`${_} IN (${Q})`),this._params.push(...Z);break;case"$nin":case"$notIn":if(!Array.isArray(Z))throw Error(`$nin/$notIn \u64CD\u4F5C\u7B26\u7684\u503C\u5FC5\u987B\u662F\u6570\u7EC4 (operator: ${z})`);if(Z.length===0)throw Error("$nin/$notIn \u64CD\u4F5C\u7B26\u7684\u6570\u7EC4\u4E0D\u80FD\u4E3A\u7A7A\u3002\u63D0\u793A\uFF1A\u7A7A\u6570\u7EC4\u4F1A\u5BFC\u81F4\u67E5\u8BE2\u5339\u914D\u6240\u6709\u8BB0\u5F55\uFF0C\u8FD9\u901A\u5E38\u4E0D\u662F\u9884\u671F\u884C\u4E3A\u3002\u8BF7\u68C0\u67E5\u67E5\u8BE2\u6761\u4EF6\u6216\u79FB\u9664\u8BE5\u5B57\u6BB5\u3002");let Y=Z.map(()=>"?").join(",");this._where.push(`${_} NOT IN (${Y})`),this._params.push(...Z);break;case"$like":this._validateParam(Z),this._where.push(`${_} LIKE ?`),this._params.push(Z);break;case"$notLike":this._validateParam(Z),this._where.push(`${_} NOT LIKE ?`),this._params.push(Z);break;case"$gt":this._validateParam(Z),this._where.push(`${_} > ?`),this._params.push(Z);break;case"$gte":this._validateParam(Z),this._where.push(`${_} >= ?`),this._params.push(Z);break;case"$lt":this._validateParam(Z),this._where.push(`${_} < ?`),this._params.push(Z);break;case"$lte":this._validateParam(Z),this._where.push(`${_} <= ?`),this._params.push(Z);break;case"$between":if(Array.isArray(Z)&&Z.length===2)this._validateParam(Z[0]),this._validateParam(Z[1]),this._where.push(`${_} BETWEEN ? AND ?`),this._params.push(Z[0],Z[1]);break;case"$notBetween":if(Array.isArray(Z)&&Z.length===2)this._validateParam(Z[0]),this._validateParam(Z[1]),this._where.push(`${_} NOT BETWEEN ? AND ?`),this._params.push(Z[0],Z[1]);break;case"$null":if(Z===!0)this._where.push(`${_} IS NULL`);break;case"$notNull":if(Z===!0)this._where.push(`${_} IS NOT NULL`);break;default:this._validateParam(Z),this._where.push(`${_} = ?`),this._params.push(Z)}}_processWhereConditions($){if(!$||typeof $!=="object")return;Object.entries($).forEach(([z,Z])=>{if(Z===void 0)return;if(z==="$and"){if(Array.isArray(Z))Z.forEach((_)=>this._processWhereConditions(_))}else if(z==="$or"){if(Array.isArray(Z)){let _=[],Q=[];if(Z.forEach((Y)=>{let U=new T;if(U._processWhereConditions(Y),U._where.length>0)_.push(`(${U._where.join(" AND ")})`),Q.push(...U._params)}),_.length>0)this._where.push(`(${_.join(" OR ")})`),this._params.push(...Q)}}else if(z.includes("$")){let _=z.lastIndexOf("$"),Q=z.substring(0,_),Y="$"+z.substring(_+1);this._applyOperator(Q,Y,Z)}else if(typeof Z==="object"&&Z!==null&&!Array.isArray(Z))for(let[_,Q]of Object.entries(Z))this._applyOperator(z,_,Q);else{this._validateParam(Z);let _=this._escapeField(z);this._where.push(`${_} = ?`),this._params.push(Z)}})}getWhereConditions(){return{sql:this._where.length>0?this._where.join(" AND "):"",params:[...this._params]}}select($="*"){if(Array.isArray($))this._select=[...this._select,...$.map((z)=>this._escapeField(z))];else if(typeof $==="string")this._select.push(this._escapeField($));else throw Error("SELECT \u5B57\u6BB5\u5FC5\u987B\u662F\u5B57\u7B26\u4E32\u6216\u6570\u7EC4");return this}from($){if(typeof $!=="string"||!$.trim())throw Error(`FROM \u8868\u540D\u5FC5\u987B\u662F\u975E\u7A7A\u5B57\u7B26\u4E32 (table: ${$})`);return this._from=this._escapeTable($.trim()),this}where($,z){if(typeof $==="object"&&$!==null)this._processWhereConditions($);else if(z!==void 0&&z!==null){this._validateParam(z);let Z=this._escapeField($);this._where.push(`${Z} = ?`),this._params.push(z)}else if(typeof $==="string")this._where.push($);return this}leftJoin($,z){if(typeof $!=="string"||typeof z!=="string")throw Error(`JOIN \u8868\u540D\u548C\u6761\u4EF6\u5FC5\u987B\u662F\u5B57\u7B26\u4E32 (table: ${$}, on: ${z})`);let Z=this._escapeTable($);return this._joins.push(`LEFT JOIN ${Z} ON ${z}`),this}orderBy($){if(!Array.isArray($))throw Error('orderBy \u5FC5\u987B\u662F\u5B57\u7B26\u4E32\u6570\u7EC4\uFF0C\u683C\u5F0F\u4E3A "\u5B57\u6BB5#\u65B9\u5411"');return $.forEach((z)=>{if(typeof z!=="string"||!z.includes("#"))throw Error(`orderBy \u5B57\u6BB5\u5FC5\u987B\u662F "\u5B57\u6BB5#\u65B9\u5411" \u683C\u5F0F\u7684\u5B57\u7B26\u4E32\uFF08\u4F8B\u5982\uFF1A"name#ASC", "id#DESC"\uFF09 (item: ${z})`);let[Z,_]=z.split("#"),Q=Z.trim(),Y=_.trim().toUpperCase();if(!Q)throw Error(`orderBy \u4E2D\u5B57\u6BB5\u540D\u4E0D\u80FD\u4E3A\u7A7A (item: ${z})`);if(!["ASC","DESC"].includes(Y))throw Error(`ORDER BY \u65B9\u5411\u5FC5\u987B\u662F ASC \u6216 DESC (direction: ${Y})`);let U=this._escapeField(Q);this._orderBy.push(`${U} ${Y}`)}),this}groupBy($){if(Array.isArray($)){let z=$.filter((Z)=>typeof Z==="string").map((Z)=>this._escapeField(Z));this._groupBy=[...this._groupBy,...z]}else if(typeof $==="string")this._groupBy.push(this._escapeField($));return this}having($){if(typeof $==="string")this._having.push($);return this}limit($,z){if(typeof $!=="number"||$<0)throw Error(`LIMIT \u6570\u91CF\u5FC5\u987B\u662F\u975E\u8D1F\u6570 (count: ${$})`);if(this._limit=Math.floor($),z!==void 0&&z!==null){if(typeof z!=="number"||z<0)throw Error(`OFFSET \u5FC5\u987B\u662F\u975E\u8D1F\u6570 (offset: ${z})`);this._offset=Math.floor(z)}return this}offset($){if(typeof $!=="number"||$<0)throw Error(`OFFSET \u5FC5\u987B\u662F\u975E\u8D1F\u6570 (count: ${$})`);return this._offset=Math.floor($),this}toSelectSql(){let $="SELECT ";if($+=this._select.length>0?this._select.join(", "):"*",!this._from)throw Error("FROM \u8868\u540D\u662F\u5FC5\u9700\u7684");if($+=` FROM ${this._from}`,this._joins.length>0)$+=" "+this._joins.join(" ");if(this._where.length>0)$+=" WHERE "+this._where.join(" AND ");if(this._groupBy.length>0)$+=" GROUP BY "+this._groupBy.join(", ");if(this._having.length>0)$+=" HAVING "+this._having.join(" AND ");if(this._orderBy.length>0)$+=" ORDER BY "+this._orderBy.join(", ");if(this._limit!==null){if($+=` LIMIT ${this._limit}`,this._offset!==null)$+=` OFFSET ${this._offset}`}return{sql:$,params:[...this._params]}}toInsertSql($,z){if(!$||typeof $!=="string")throw Error(`INSERT \u9700\u8981\u8868\u540D (table: ${$})`);if(!z||typeof z!=="object")throw Error(`INSERT \u9700\u8981\u6570\u636E (table: ${$}, data: ${JSON.stringify(z)})`);let Z=this._escapeTable($);if(Array.isArray(z)){if(z.length===0)throw Error(`\u63D2\u5165\u6570\u636E\u4E0D\u80FD\u4E3A\u7A7A (table: ${$})`);let _=Object.keys(z[0]);if(_.length===0)throw Error(`\u63D2\u5165\u6570\u636E\u5FC5\u987B\u81F3\u5C11\u6709\u4E00\u4E2A\u5B57\u6BB5 (table: ${$})`);let Q=_.map((H)=>this._escapeField(H)),Y=_.map(()=>"?").join(", "),U=z.map(()=>`(${Y})`).join(", "),G=`INSERT INTO ${Z} (${Q.join(", ")}) VALUES ${U}`,A=z.flatMap((H)=>_.map((X)=>H[X]));return{sql:G,params:A}}else{let _=Object.keys(z);if(_.length===0)throw Error(`\u63D2\u5165\u6570\u636E\u5FC5\u987B\u81F3\u5C11\u6709\u4E00\u4E2A\u5B57\u6BB5 (table: ${$})`);let Q=_.map((A)=>this._escapeField(A)),Y=_.map(()=>"?").join(", "),U=`INSERT INTO ${Z} (${Q.join(", ")}) VALUES (${Y})`,G=_.map((A)=>z[A]);return{sql:U,params:G}}}toUpdateSql($,z){if(!$||typeof $!=="string")throw Error("UPDATE \u9700\u8981\u8868\u540D");if(!z||typeof z!=="object"||Array.isArray(z))throw Error("UPDATE \u9700\u8981\u6570\u636E\u5BF9\u8C61");let Z=Object.keys(z);if(Z.length===0)throw Error("\u66F4\u65B0\u6570\u636E\u5FC5\u987B\u81F3\u5C11\u6709\u4E00\u4E2A\u5B57\u6BB5");let _=this._escapeTable($),Q=Z.map((G)=>`${this._escapeField(G)} = ?`),Y=[...Object.values(z),...this._params],U=`UPDATE ${_} SET ${Q.join(", ")}`;if(this._where.length>0)U+=" WHERE "+this._where.join(" AND ");else throw Error("\u4E3A\u5B89\u5168\u8D77\u89C1\uFF0CUPDATE \u9700\u8981 WHERE \u6761\u4EF6");return{sql:U,params:Y}}toDeleteSql($){if(!$||typeof $!=="string")throw Error("DELETE \u9700\u8981\u8868\u540D");let Z=`DELETE FROM ${this._escapeTable($)}`;if(this._where.length>0)Z+=" WHERE "+this._where.join(" AND ");else throw Error("\u4E3A\u5B89\u5168\u8D77\u89C1\uFF0CDELETE \u9700\u8981 WHERE \u6761\u4EF6");return{sql:Z,params:[...this._params]}}toCountSql(){let $="SELECT COUNT(*) as total";if(!this._from)throw Error("COUNT \u9700\u8981 FROM \u8868\u540D");if($+=` FROM ${this._from}`,this._joins.length>0)$+=" "+this._joins.join(" ");if(this._where.length>0)$+=" WHERE "+this._where.join(" AND ");return{sql:$,params:[...this._params]}}}import H$ from"fs";import{statSync as S0,existsSync as L0}from"fs";function B0($){return Number.isSafeInteger($)&&$>=0}function I0($){return $!=null&&typeof $!=="function"&&B0($.length)}function R0($){if($==null)return $===void 0?"[object Undefined]":"[object Null]";return Object.prototype.toString.call($)}function C0($){return ArrayBuffer.isView($)&&!($ instanceof DataView)}function V0($){return $!==null&&typeof $==="object"&&R0($)==="[object Arguments]"}function w0($){let z=$?.constructor,Z=typeof z==="function"?z.prototype:Object.prototype;return $===Z}function T0($){return C0($)}function F($){if(typeof $!=="object")return!1;if($==null)return!1;if(Object.getPrototypeOf($)===null)return!0;if(Object.prototype.toString.call($)!=="[object Object]"){let Z=$[Symbol.toStringTag];if(Z==null)return!1;if(!Object.getOwnPropertyDescriptor($,Symbol.toStringTag)?.writable)return!1;return $.toString()===`[object ${Z}]`}let z=$;while(Object.getPrototypeOf(z)!==null)z=Object.getPrototypeOf(z);return Object.getPrototypeOf($)===z}function l($){if($==null)return!0;if(I0($)){if(typeof $.splice!=="function"&&typeof $!=="string"&&(typeof Buffer>"u"||!Buffer.isBuffer($))&&!T0($)&&!V0($))return!1;return $.length===0}if(typeof $==="object"){if($ instanceof Map||$ instanceof Set)return $.size===0;let z=Object.keys($);if(w0($))return z.filter((Z)=>Z!=="constructor").length===0;return z.length===0}return!0}import{fileURLToPath as A$}from"url";var W$=A$(import.meta.url),u=Q0(W$),X$=u,P1=R(u,"checks"),F0=R(u,"plugins"),E1=R(u,"apis"),q1=R(u,"tables"),S=process.cwd(),D1=R(S,"checks"),Y0=R(S,"plugins"),x=R(S,"apis"),U0=R(S,"tables"),N1=R(S,"addons");var M$=($="",z={},Z={})=>{return{...Z,code:0,msg:$,data:z}},P=($="",z={},Z={})=>{return{...Z,code:1,msg:$,data:z}},y=($)=>{if(!$||!F($))return $;let z={};for(let[Z,_]of Object.entries($)){let Q=C(Z);z[Q]=_}return z},n=($)=>{if(!$||!F($))return $;let z={};for(let[Z,_]of Object.entries($)){let Q=D(Z);z[Q]=_}return z},p=($)=>{if(!$||!Array.isArray($))return $;return $.map((z)=>n(z))},m=($,z)=>{if(!$||!F($)&&!Array.isArray($))return{};let Z={};for(let _ of z)if(_ in $)Z[_]=$[_];return Z},a=($,z=[null,void 0],Z={})=>{if(!$||!F($))return{};let _={};for(let[Q,Y]of Object.entries($)){if(Q in Z){if(Object.is(Z[Q],Y)){_[Q]=Y;continue}}if(z.some((G)=>Object.is(G,Y)))continue;_[Q]=Y}return _},N=($,z=Bun.nanoseconds())=>{let Z=(z-$)/1e6;if(Z<1000)return`${Z.toFixed(2)} \u6BEB\u79D2`;else return`${(Z/1000).toFixed(2)} \u79D2`},q=()=>{let $=new Set,z=R(S,"node_modules","@befly-addon");if(L0(z))try{H$.readdirSync(z).filter((_)=>{if($.has(_))return!1;let Q=R(z,_);try{return S0(Q).isDirectory()}catch{return!1}}).forEach((_)=>$.add(_))}catch{}return Array.from($).sort()},E=($,z)=>{return R(S,"node_modules","@befly-addon",$,z)},h=($,z)=>{let Z=E($,z);return L0(Z)&&S0(Z).isDirectory()};class o{befly;sql=null;isTransaction=!1;constructor($,z=null){this.befly=$,this.sql=z,this.isTransaction=!!z}validateAndClassifyFields($){if(!$||$.length===0)return{type:"all",fields:[]};if($.some((_)=>_==="*"))throw Error("fields \u4E0D\u652F\u6301 * \u661F\u53F7\uFF0C\u8BF7\u4F7F\u7528\u7A7A\u6570\u7EC4 [] \u6216\u4E0D\u4F20\u53C2\u6570\u8868\u793A\u67E5\u8BE2\u6240\u6709\u5B57\u6BB5");if($.some((_)=>!_||typeof _!=="string"||_.trim()===""))throw Error("fields \u4E0D\u80FD\u5305\u542B\u7A7A\u5B57\u7B26\u4E32\u6216\u65E0\u6548\u503C");let z=$.filter((_)=>!_.startsWith("!")),Z=$.filter((_)=>_.startsWith("!"));if(z.length>0&&Z.length===0)return{type:"include",fields:z};if(Z.length>0&&z.length===0)return{type:"exclude",fields:Z.map((Q)=>Q.substring(1))};throw Error(`fields \u4E0D\u80FD\u540C\u65F6\u5305\u542B\u666E\u901A\u5B57\u6BB5\u548C\u6392\u9664\u5B57\u6BB5\uFF08! \u5F00\u5934\uFF09\u3002\u53EA\u80FD\u4F7F\u7528\u4EE5\u4E0B3\u79CD\u65B9\u5F0F\u4E4B\u4E00\uFF1A
1. \u7A7A\u6570\u7EC4 [] \u6216\u4E0D\u4F20\uFF08\u67E5\u8BE2\u6240\u6709\uFF09
2. \u5168\u90E8\u6307\u5B9A\u5B57\u6BB5 ["id", "name"]
3. \u5168\u90E8\u6392\u9664\u5B57\u6BB5 ["!password", "!token"]`)}async getTableColumns($){let z=`table:columns:${$}`,Z=await this.befly.redis.getObject(z);if(Z&&Z.length>0)return Z;let _=`SHOW COLUMNS FROM \`${$}\``,Q=await this.executeWithConn(_);if(!Q||Q.length===0)throw Error(`\u8868 ${$} \u4E0D\u5B58\u5728\u6216\u6CA1\u6709\u5B57\u6BB5`);return Z=Q.map((Y)=>Y.Field),await this.befly.redis.setObject(z,Z,3600),Z}async fieldsToSnake($,z){if(!z||!Array.isArray(z))return["*"];let{type:Z,fields:_}=this.validateAndClassifyFields(z);if(Z==="all")return["*"];if(Z==="include")return _.map((Q)=>{if(Q.includes("(")||Q.includes(" "))return Q;return C(Q)});if(Z==="exclude"){let Q=await this.getTableColumns($),Y=_.map((G)=>C(G)),U=Q.filter((G)=>!Y.includes(G));if(U.length===0)throw Error(`\u6392\u9664\u5B57\u6BB5\u540E\u6CA1\u6709\u5269\u4F59\u5B57\u6BB5\u53EF\u67E5\u8BE2\u3002\u8868: ${$}, \u6392\u9664: ${Y.join(", ")}`);return U}return["*"]}orderByToSnake($){if(!$||!Array.isArray($))return $;return $.map((z)=>{if(typeof z!=="string"||!z.includes("#"))return z;let[Z,_]=z.split("#");return`${C(Z.trim())}#${_.trim()}`})}async prepareQueryOptions($){let z=this.cleanFields($.where),Z=await this.fieldsToSnake(C($.table),$.fields||[]);return{table:C($.table),fields:Z,where:this.whereKeysToSnake(z),orderBy:this.orderByToSnake($.orderBy||[]),page:$.page||1,limit:$.limit||10}}addDefaultStateFilter($={}){if(Object.keys($).some((Z)=>Z.startsWith("state")))return $;return{...$,state$gt:0}}cleanFields($,z=[null,void 0],Z={}){return a($||{},z,Z)}convertBigIntFields($,z=["id","pid","sort"]){if(!$||!Array.isArray($))return $;return $.map((Z)=>{let _={...Z};for(let[Q,Y]of Object.entries(_)){if(Y===void 0||Y===null)continue;if((z.includes(Q)||Q.endsWith("Id")||Q.endsWith("_id")||Q.endsWith("At")||Q.endsWith("_at"))&&typeof Y==="string"){let G=Number(Y);if(!isNaN(G))_[Q]=G}}return _})}whereKeysToSnake($){if(!$||typeof $!=="object")return $;if(Array.isArray($))return $.map((Z)=>this.whereKeysToSnake(Z));let z={};for(let[Z,_]of Object.entries($)){if(Z==="$or"||Z==="$and"){z[Z]=_.map((Y)=>this.whereKeysToSnake(Y));continue}if(Z.includes("$")){let Y=Z.lastIndexOf("$"),U=Z.substring(0,Y),G=Z.substring(Y),A=C(U)+G;z[A]=_;continue}let Q=C(Z);if(typeof _==="object"&&_!==null&&!Array.isArray(_))z[Q]=this.whereKeysToSnake(_);else z[Q]=_}return z}async executeWithConn($,z){if(!this.sql)throw Error("\u6570\u636E\u5E93\u8FDE\u63A5\u672A\u521D\u59CB\u5316");if(typeof $!=="string")throw Error(`executeWithConn \u53EA\u63A5\u53D7\u5B57\u7B26\u4E32\u7C7B\u578B\u7684 SQL\uFF0C\u6536\u5230\u7C7B\u578B: ${typeof $}\uFF0C\u503C: ${JSON.stringify($)}`);let Z=Date.now();try{let _;if(z&&z.length>0)_=await this.sql.unsafe($,z);else _=await this.sql.unsafe($);let Q=Date.now()-Z;if(Q>1000){let Y=$.length>100?$.substring(0,100)+"...":$;W.warn(`\uD83D\uDC0C \u68C0\u6D4B\u5230\u6162\u67E5\u8BE2 (${Q}ms): ${Y}`)}return _}catch(_){let Q=Date.now()-Z;if(W.error("\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501"),W.error("SQL \u6267\u884C\u9519\u8BEF"),W.error("\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501"),W.error(`SQL \u8BED\u53E5: ${$.length>200?$.substring(0,200)+"...":$}`),W.error(`\u53C2\u6570\u5217\u8868: ${JSON.stringify(z||[])}`),W.error(`\u6267\u884C\u8017\u65F6: ${Q}ms`),W.error(`\u9519\u8BEF\u4FE1\u606F: ${_.message}`),_.stack)W.error(`\u9519\u8BEF\u5806\u6808:
${_.stack}`);W.error("\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501");let Y=Error(`SQL\u6267\u884C\u5931\u8D25: ${_.message}`);throw Y.originalError=_,Y.sql=$,Y.params=z||[],Y.duration=Q,Y}}async tableExists($){let z=C($);return(await this.executeWithConn("SELECT COUNT(*) as count FROM information_schema.TABLES WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = ?",[z]))?.[0]?.count>0}async getCount($){let{table:z,where:Z}=await this.prepareQueryOptions($),_=new T().select(["COUNT(*) as count"]).from(z).where(this.addDefaultStateFilter(Z)),{sql:Q,params:Y}=_.toSelectSql();return(await this.executeWithConn(Q,Y))?.[0]?.count||0}async getOne($){let{table:z,fields:Z,where:_}=await this.prepareQueryOptions($),Q=new T().select(Z).from(z).where(this.addDefaultStateFilter(_)),{sql:Y,params:U}=Q.toSelectSql(),A=(await this.executeWithConn(Y,U))?.[0]||null;if(!A)return null;let H=n(A);return this.convertBigIntFields([H])[0]}async getList($){let z=await this.prepareQueryOptions($);if(z.page<1||z.page>1e4)throw Error(`\u9875\u7801\u5FC5\u987B\u5728 1 \u5230 10000 \u4E4B\u95F4 (table: ${$.table}, page: ${z.page}, limit: ${z.limit})`);if(z.limit<1||z.limit>1000)throw Error(`\u6BCF\u9875\u6570\u91CF\u5FC5\u987B\u5728 1 \u5230 1000 \u4E4B\u95F4 (table: ${$.table}, page: ${z.page}, limit: ${z.limit})`);let Z=this.addDefaultStateFilter(z.where),_=new T().select(["COUNT(*) as total"]).from(z.table).where(Z),{sql:Q,params:Y}=_.toSelectSql(),G=(await this.executeWithConn(Q,Y))?.[0]?.total||0;if(G===0)return{lists:[],total:0,page:z.page,limit:z.limit,pages:0};let A=(z.page-1)*z.limit,H=new T().select(z.fields).from(z.table).where(Z).limit(z.limit).offset(A);if(z.orderBy&&z.orderBy.length>0)H.orderBy(z.orderBy);let{sql:X,params:K}=H.toSelectSql(),O=await this.executeWithConn(X,K)||[],J=p(O);return{lists:this.convertBigIntFields(J),total:G,page:z.page,limit:z.limit,pages:Math.ceil(G/z.limit)}}async getAll($){let _=await this.prepareQueryOptions({...$,page:1,limit:10}),Q=new T().select(_.fields).from(_.table).where(this.addDefaultStateFilter(_.where)).limit(1e4);if(_.orderBy&&_.orderBy.length>0)Q.orderBy(_.orderBy);let{sql:Y,params:U}=Q.toSelectSql(),G=await this.executeWithConn(Y,U)||[];if(G.length>=1000)W.warn(`\u26A0\uFE0F getAll \u4ECE\u8868 \`${$.table}\` \u8FD4\u56DE\u4E86 ${G.length} \u884C\u6570\u636E\uFF0C\u5EFA\u8BAE\u4F7F\u7528 getList \u5206\u9875\u67E5\u8BE2\u4EE5\u83B7\u5F97\u66F4\u597D\u7684\u6027\u80FD\u3002`);if(G.length>=1e4)W.warn(`\uD83D\uDEA8 getAll \u8FBE\u5230\u4E86\u6700\u5927\u9650\u5236 (${1e4})\uFF0C\u53EF\u80FD\u8FD8\u6709\u66F4\u591A\u6570\u636E\u3002\u8BF7\u4F7F\u7528 getList \u5206\u9875\u67E5\u8BE2\u3002`);let A=p(G);return this.convertBigIntFields(A)}async insData($){let{table:z,data:Z}=$,_=this.cleanFields(Z),Q=C(z),Y=y(_),{id:U,created_at:G,updated_at:A,deleted_at:H,state:X,...K}=Y,O={...K};try{O.id=await this.befly.redis.genTimeID()}catch(s){throw Error(`\u751F\u6210 ID \u5931\u8D25\uFF0CRedis \u53EF\u80FD\u4E0D\u53EF\u7528 (table: ${z})`,s)}let J=Date.now();O.created_at=J,O.updated_at=J,O.state=1;let B=new T,{sql:I,params:j}=B.toInsertSql(Q,O),t=await this.executeWithConn(I,j);return O.id||t?.lastInsertRowid||0}async insBatch($,z){if(z.length===0)return[];let Z=1000;if(z.length>Z)throw Error(`\u6279\u91CF\u63D2\u5165\u6570\u91CF ${z.length} \u8D85\u8FC7\u6700\u5927\u9650\u5236 ${Z}`);let _=C($),Q=await this.befly.redis.genTimeIDBatch(z.length),Y=Date.now(),U=z.map((X,K)=>{let O=this.cleanFields(X),J=y(O),{id:B,created_at:I,updated_at:j,deleted_at:t,state:s,...W0}=J;return{...W0,id:Q[K],created_at:Y,updated_at:Y,state:1}}),G=new T,{sql:A,params:H}=G.toInsertSql(_,U);try{return await this.executeWithConn(A,H),Q}catch(X){throw W.error(`\u8868 \`${$}\` \u6279\u91CF\u63D2\u5165\u5931\u8D25`,X),X}}async updData($){let{table:z,data:Z,where:_}=$,Q=this.cleanFields(Z),Y=this.cleanFields(_),U=C(z),G=y(Q),A=this.whereKeysToSnake(Y),{id:H,created_at:X,updated_at:K,deleted_at:O,...J}=G,B={...J,updated_at:Date.now()},I=this.addDefaultStateFilter(A),j=new T().where(I),{sql:t,params:s}=j.toUpdateSql(U,B);return(await this.executeWithConn(t,s))?.changes||0}async delData($){let{table:z,where:Z}=$;return await this.updData({table:z,data:{state:0,deleted_at:Date.now()},where:Z})}async delForce($){let{table:z,where:Z}=$,_=C(z),Q=this.cleanFields(Z),Y=this.whereKeysToSnake(Q),U=new T().where(Y),{sql:G,params:A}=U.toDeleteSql(_);return(await this.executeWithConn(G,A))?.changes||0}async disableData($){let{table:z,where:Z}=$;return await this.updData({table:z,data:{state:2},where:Z})}async enableData($){let{table:z,where:Z}=$;return await this.updData({table:z,data:{state:1},where:Z})}async trans($){if(this.isTransaction)return await $(this);let z=await this.befly.db.transaction(),Z=!1;try{let _=new o(this.befly,z),Q=await $(_);try{await z.query("COMMIT"),Z=!0}catch(Y){throw W.error("\u4E8B\u52A1\u63D0\u4EA4\u5931\u8D25\uFF0C\u6B63\u5728\u56DE\u6EDA",Y),await z.query("ROLLBACK"),Error(`\u4E8B\u52A1\u63D0\u4EA4\u5931\u8D25: ${Y.message}`)}return Q}catch(_){if(!Z)try{await z.query("ROLLBACK"),W.warn("\u4E8B\u52A1\u5DF2\u56DE\u6EDA")}catch(Q){W.error("\u4E8B\u52A1\u56DE\u6EDA\u5931\u8D25",Q)}throw _}}async query($,z){return await this.executeWithConn($,z)}async exists($){let{table:z,where:Z}=await this.prepareQueryOptions({...$,page:1,limit:1}),_=new T().select(["COUNT(1) as cnt"]).from(z).where(this.addDefaultStateFilter(Z)).limit(1),{sql:Q,params:Y}=_.toSelectSql();return((await this.executeWithConn(Q,Y))?.[0]?.cnt||0)>0}async getFieldValue($){let{field:z,...Z}=$;if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(z))throw Error(`\u65E0\u6548\u7684\u5B57\u6BB5\u540D: ${z}\uFF0C\u53EA\u5141\u8BB8\u5B57\u6BCD\u3001\u6570\u5B57\u548C\u4E0B\u5212\u7EBF`);let _=await this.getOne({...Z,fields:[z]});if(!_)return null;if(z in _)return _[z];let Q=z.replace(/_([a-z])/g,(U,G)=>G.toUpperCase());if(Q!==z&&Q in _)return _[Q];let Y=z.replace(/[A-Z]/g,(U)=>`_${U.toLowerCase()}`);if(Y!==z&&Y in _)return _[Y];return null}async increment($,z,Z,_=1){let Q=C($),Y=C(z);if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(Q))throw Error(`\u65E0\u6548\u7684\u8868\u540D: ${Q}`);if(!/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(Y))throw Error(`\u65E0\u6548\u7684\u5B57\u6BB5\u540D: ${z}`);if(typeof _!=="number"||isNaN(_))throw Error(`\u81EA\u589E\u503C\u5FC5\u987B\u662F\u6709\u6548\u7684\u6570\u5B57 (table: ${$}, field: ${z}, value: ${_})`);let U=this.cleanFields(Z),G=this.whereKeysToSnake(U),A=this.addDefaultStateFilter(G),H=new T().where(A),{sql:X,params:K}=H.getWhereConditions(),O=X?`UPDATE \`${Q}\` SET \`${Y}\` = \`${Y}\` + ? WHERE ${X}`:`UPDATE \`${Q}\` SET \`${Y}\` = \`${Y}\` + ?`;return(await this.executeWithConn(O,[_,...K]))?.changes||0}async decrement($,z,Z,_=1){return await this.increment($,z,Z,-_)}}var w=M.REDIS_KEY_PREFIX?`${M.REDIS_KEY_PREFIX}:`:"";class e{client;constructor(){let $=d.getRedis();if(!$)throw Error("Redis \u5BA2\u6237\u7AEF\u672A\u521D\u59CB\u5316\uFF0C\u8BF7\u5148\u8C03\u7528 Database.connectRedis()");this.client=$}async setObject($,z,Z=null){try{let _=JSON.stringify(z),Q=`${w}${$}`;if(Z)return await this.client.setex(Q,Z,_);return await this.client.set(Q,_)}catch(_){return W.error("Redis setObject \u9519\u8BEF",_),null}}async getObject($){try{let z=`${w}${$}`,Z=await this.client.get(z);return Z?JSON.parse(Z):null}catch(z){return W.error("Redis getObject \u9519\u8BEF",z),null}}async delObject($){try{let z=`${w}${$}`;await this.client.del(z)}catch(z){W.error("Redis delObject \u9519\u8BEF",z)}}async genTimeID(){let $=Math.floor(Date.now()/1000),z=`${w}time_id_counter:${$}`,Z=await this.client.incr(z);await this.client.expire(z,1);let _=(Z%1e4).toString().padStart(4,"0");return Number(`${$}${_}`)}async genTimeIDBatch($){if($<=0)return[];let z=1e4;if($>z)throw Error(`\u6279\u91CF\u5927\u5C0F ${$} \u8D85\u8FC7\u6700\u5927\u9650\u5236 ${z}`);let Z=Math.floor(Date.now()/1000),_=`${w}time_id_counter:${Z}`,Q=await this.client.incrby(_,$);await this.client.expire(_,1);let Y=[];for(let U=0;U<$;U++){let A=((Q-$+U+1)%1e4).toString().padStart(4,"0");Y.push(Number(`${Z}${A}`))}return Y}async setString($,z,Z=null){try{let _=`${w}${$}`;if(Z)return await this.client.setex(_,Z,z);return await this.client.set(_,z)}catch(_){return W.error("Redis setString \u9519\u8BEF",_),null}}async getString($){try{let z=`${w}${$}`;return await this.client.get(z)}catch(z){return W.error("Redis getString \u9519\u8BEF",z),null}}async exists($){try{let z=`${w}${$}`;return await this.client.exists(z)}catch(z){return W.error("Redis exists \u9519\u8BEF",z),0}}async expire($,z){try{let Z=`${w}${$}`;return await this.client.expire(Z,z)}catch(Z){return W.error("Redis expire \u9519\u8BEF",Z),0}}async ttl($){try{let z=`${w}${$}`;return await this.client.ttl(z)}catch(z){return W.error("Redis ttl \u9519\u8BEF",z),-1}}async sadd($,z){try{if(z.length===0)return 0;let Z=`${w}${$}`;return await this.client.sadd(Z,...z)}catch(Z){return W.error("Redis sadd \u9519\u8BEF",Z),0}}async sismember($,z){try{let Z=`${w}${$}`;return await this.client.sismember(Z,z)}catch(Z){return W.error("Redis sismember \u9519\u8BEF",Z),0}}async scard($){try{let z=`${w}${$}`;return await this.client.scard(z)}catch(z){return W.error("Redis scard \u9519\u8BEF",z),0}}async smembers($){try{let z=`${w}${$}`;return await this.client.smembers(z)}catch(z){return W.error("Redis smembers \u9519\u8BEF",z),[]}}async del($){try{let z=`${w}${$}`;return await this.client.del(z)}catch(z){return W.error("Redis del \u9519\u8BEF",z),0}}async ping(){try{return await this.client.ping()}catch($){throw W.error("Redis ping \u9519\u8BEF",$),$}}}class d{static sqlClient=null;static redisClient=null;static dbHelper=null;static async connectSql($={}){let z=M.DB_TYPE||"",Z=M.DB_HOST||"",_=M.DB_PORT,Q=encodeURIComponent(M.DB_USER||""),Y=encodeURIComponent(M.DB_PASS||""),U=encodeURIComponent(M.DB_NAME||""),G;if(z==="sqlite")G=U;else{if(!Z||!U)throw Error("\u6570\u636E\u5E93\u914D\u7F6E\u4E0D\u5B8C\u6574\uFF0C\u8BF7\u68C0\u67E5\u73AF\u5883\u53D8\u91CF");G=`${z}://${Q}:${Y}@${Z}:${_}/${U}`}let A;if(M.DB_TYPE==="sqlite")A=new P0(G);else A=new P0({url:G,max:$.max??1,bigint:!1,...$});try{let H=$.connectionTimeout??30000,X=(async()=>{let J="";if(M.DB_TYPE==="sqlite")J=(await A`SELECT sqlite_version() AS version`)?.[0]?.version;else if(M.DB_TYPE==="postgresql"||M.DB_TYPE==="postgres")J=(await A`SELECT version() AS version`)?.[0]?.version;else J=(await A`SELECT VERSION() AS version`)?.[0]?.version;return J})(),K=new Promise((J,B)=>{setTimeout(()=>{B(Error(`\u6570\u636E\u5E93\u8FDE\u63A5\u8D85\u65F6 (${H}ms)`))},H)}),O=await Promise.race([X,K]);return this.sqlClient=A,A}catch(H){console.log(G),W.error("\u6570\u636E\u5E93\u8FDE\u63A5\u6D4B\u8BD5\u5931\u8D25",H);try{await A?.close()}catch(X){}throw H}}static async disconnectSql(){if(this.sqlClient){try{await this.sqlClient.close()}catch($){W.error("\u5173\u95ED SQL \u8FDE\u63A5\u65F6\u51FA\u9519",$)}this.sqlClient=null}if(this.dbHelper)this.dbHelper=null}static getSql(){if(!this.sqlClient)throw Error("SQL \u5BA2\u6237\u7AEF\u672A\u8FDE\u63A5\uFF0C\u8BF7\u5148\u8C03\u7528 Database.connectSql()");return this.sqlClient}static getDbHelper($){if(!this.dbHelper){if(!this.sqlClient)throw Error("SQL \u5BA2\u6237\u7AEF\u672A\u8FDE\u63A5\uFF0C\u8BF7\u5148\u8C03\u7528 Database.connectSql()");let z=$||{redis:new e,db:null,tool:null,logger:null};this.dbHelper=new o(z,this.sqlClient)}return this.dbHelper}static async connectRedis(){try{let{REDIS_HOST:$,REDIS_PORT:z,REDIS_USERNAME:Z,REDIS_PASSWORD:_,REDIS_DB:Q}=M,Y="";if(Z&&_)Y=`${Z}:${_}@`;else if(_)Y=`:${_}@`;let U=`redis://${Y}${$}:${z}/${Q}`,G=new O$(U,{connectionTimeout:30000,idleTimeout:0,autoReconnect:!0,maxRetries:3,enableOfflineQueue:!0,enableAutoPipelining:!0});return await G.ping(),this.redisClient=G,G}catch($){throw W.error("Redis \u8FDE\u63A5\u5931\u8D25",$),Error(`Redis \u8FDE\u63A5\u5931\u8D25: ${$.message}`)}}static async disconnectRedis(){if(this.redisClient){try{this.redisClient.close()}catch($){W.error("\u5173\u95ED Redis \u8FDE\u63A5\u65F6\u51FA\u9519",$)}this.redisClient=null}}static getRedis(){if(!this.redisClient)throw Error("Redis \u5BA2\u6237\u7AEF\u672A\u8FDE\u63A5\uFF0C\u8BF7\u5148\u8C03\u7528 Database.connectRedis()");return this.redisClient}static async connect($){try{if($?.sql!==!1)await this.connectSql($?.sql);if($?.redis!==!1)await this.connectRedis()}catch(z){throw W.error("\u6570\u636E\u5E93\u521D\u59CB\u5316\u5931\u8D25",z),await this.disconnect(),z}}static async disconnect(){await this.disconnectSql(),await this.disconnectRedis()}static isConnected(){return{sql:this.sqlClient!==null,redis:this.redisClient!==null}}static __setMockSql($){this.sqlClient=$}static __setMockRedis($){this.redisClient=$}static __reset(){this.sqlClient=null,this.redisClient=null,this.dbHelper=null}}import{existsSync as K$}from"fs";import{existsSync as J$}from"fs";async function L($,z="**/*.{ts,js}",Z=!0){if(!J$($))return[];let _=g($),Q=new Bun.Glob(z),Y=[];for await(let U of Q.scan({cwd:$,onlyFiles:!0,absolute:!0})){if(U.endsWith(".d.ts"))continue;let G=g(U),A=f(G).replace(/\.[^.]+$/,""),H=_0(_,G).replace(/\.[^/.]+$/,"");if(Z){if(A.startsWith("_"))continue;if(H.split("/").some((X)=>X.startsWith("_")))continue}Y.push({filePath:G,relativePath:H,fileName:A})}return Y}async function A0($,z,Z,_){let Q=[];for(let{filePath:Y,fileName:U}of $){let G=Z(U,Y);if(z.has(G))continue;try{let X=(await import(Y.replace(/\\/g,"/"))).default;X.pluginName=G,Q.push(X),z.add(G)}catch(A){let H=_(U,Y);W.error(`${H} \u5BFC\u5165\u5931\u8D25`,A),process.exit(1)}}return Q}function B$($){let z=[],Z=new Set,_=new Set,Q=Object.fromEntries($.map((G)=>[G.pluginName,G])),Y=!0,U=(G)=>{if(Z.has(G))return;if(_.has(G)){Y=!1;return}let A=Q[G];if(!A)return;_.add(G),(A.after||[]).forEach(U),_.delete(G),Z.add(G),z.push(A)};return $.forEach((G)=>U(G.pluginName)),Y?z:!1}async function I$($){let z=await L(F0,"*.{ts,js}");return A0(z,$,(Z)=>D(Z),(Z)=>`\u6838\u5FC3\u63D2\u4EF6 ${Z}`)}async function R$($){let z=[],Z=q();for(let _ of Z){if(!h(_,"plugins"))continue;let Q=E(_,"plugins"),Y=await L(Q,"*.{ts,js}"),U=await A0(Y,$,(G)=>{let A=D(_),H=D(G);return`addon_${A}_${H}`},(G)=>`\u7EC4\u4EF6${_} ${G}`);z.push(...U)}return z}async function C$($){if(!K$(Y0))return[];let z=await L(Y0,"*.{ts,js}");return A0(z,$,(Z)=>`app_${D(Z)}`,(Z)=>`\u7528\u6237\u63D2\u4EF6 ${Z}`)}async function V$($,z){if($.pluginLists.push(z),typeof z?.onInit==="function")$.appContext[z.pluginName]=await z?.onInit($.appContext);else $.appContext[z.pluginName]={}}async function G0($,z,Z){let _=B$(z);if(_===!1)W.error(`${Z}\u4F9D\u8D56\u5173\u7CFB\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\u63D2\u4EF6\u7684 after \u5C5E\u6027`),process.exit(1);for(let Q of _)try{await V$($,Q)}catch(Y){W.error(`${Z} ${Q.pluginName} \u521D\u59CB\u5316\u5931\u8D25`,Y),process.exit(1)}}async function E0($){try{let z=Bun.nanoseconds(),Z=new Set,_=await I$(Z),Q=await R$(Z),Y=await C$(Z);await G0($,_,"\u6838\u5FC3\u63D2\u4EF6"),await G0($,Q,"\u7EC4\u4EF6\u63D2\u4EF6"),await G0($,Y,"\u7528\u6237\u63D2\u4EF6");let U=N(z)}catch(z){W.error("\u52A0\u8F7D\u63D2\u4EF6\u65F6\u53D1\u751F\u9519\u8BEF",z),process.exit(1)}}var w$={id:{name:"ID",type:"number",min:1,max:null},page:{name:"\u9875\u7801",type:"number",min:1,max:9999},limit:{name:"\u6BCF\u9875\u6570\u91CF",type:"number",min:1,max:100},keyword:{name:"\u5173\u952E\u8BCD",type:"string",min:1,max:50},state:{name:"\u72B6\u6001",type:"number",min:0,max:2}};async function q0($,z,Z,_){for(let{filePath:Q,relativePath:Y}of z)try{let A=(await import(Q.replace(/\\/g,"/"))).default;A.method=A.method||"POST",A.auth=A.auth!==void 0?A.auth:!0,A.fields={...w$,...A.fields||{}},A.required=A.required||[],A.route=`${A.method.toUpperCase()}/api/${Z?Z+"/":""}${Y}`,$.set(A.route,A)}catch(U){let G=_(Y);W.error(`[${G}] \u63A5\u53E3 ${Y} \u52A0\u8F7D\u5931\u8D25`,U),process.exit(1)}}async function D0($){try{let z=Bun.nanoseconds(),Z=await L(x);await q0($,Z,"",()=>"\u7528\u6237");let _=q();for(let Y of _){if(!h(Y,"apis"))continue;let U=E(Y,"apis"),G=await L(U);await q0($,G,`addon/${Y}`,()=>`\u7EC4\u4EF6${Y}`)}let Q=N(z)}catch(z){W.error("\u52A0\u8F7D API \u65F6\u53D1\u751F\u9519\u8BEF",z),process.exit(1)}}class k{options;constructor($={}){this.options={ignoreAttributes:!1,attributePrefix:"@",textKey:"#text",trimValues:!0,parseBooleans:!0,parseNumbers:!0,customParser:!0,...$}}parse($){if(typeof $!=="string")throw Error("\u65E0\u6548\u7684 XML \u6570\u636E");if($.trim()==="")throw Error("XML \u6570\u636E\u5FC5\u987B\u662F\u975E\u7A7A\u5B57\u7B26\u4E32");if($=$.replace(/<\?xml[^>]*\?>/g,"").replace(/<!--[\s\S]*?-->/g,"").trim(),!$)throw Error("XML \u6570\u636E\u5FC5\u987B\u662F\u975E\u7A7A\u5B57\u7B26\u4E32");if(this.options.customParser)return this.customParse($);return{}}parseAttributes($,z){let Z=$.replace(/^\w+\s*/,""),_=/(\w+)=["']([^"']*)["']/g,Q;while((Q=_.exec(Z))!==null){let Y=this.options.attributePrefix+Q[1],U=Q[2];if(Q[1].toLowerCase().includes("id")||Q[1]==="key"||Q[1]==="ref")z[Y]=U;else z[Y]=this.parseValue(U)}}customParse($){let z=this.parseXmlElement($,0).value,Z=Object.keys(z);if(Z.length===1)return z[Z[0]];return z}parseXmlElement($,z){let Z=$.indexOf("<",z);if(Z===-1)return{value:{},end:$.length};let _=$.indexOf(">",Z);if(_===-1)throw Error("\u683C\u5F0F\u9519\u8BEF\uFF1A\u672A\u627E\u5230\u6807\u7B7E\u7ED3\u675F\u7B26");let Q=$.slice(Z+1,_),Y={};if(Q.endsWith("/")){let X=Q.slice(0,-1).split(/\s+/)[0];if(!this.options.ignoreAttributes&&Q.includes(" "))this.parseAttributes(Q.slice(0,-1),Y);return{value:{[X]:Object.keys(Y).length>0?Y:""},end:_+1}}if(Q.startsWith("!--")){let X=$.indexOf("-->",_);if(X===-1)throw Error("\u683C\u5F0F\u9519\u8BEF\uFF1A\u672A\u627E\u5230\u6CE8\u91CA\u7ED3\u675F\u7B26");return this.parseXmlElement($,X+3)}if(Q.startsWith("![CDATA[")){let X=$.indexOf("]]>",_);if(X===-1)throw Error("\u683C\u5F0F\u9519\u8BEF\uFF1A\u672A\u627E\u5230 CDATA \u7ED3\u675F\u7B26");return this.parseXmlElement($,X+3)}let U=Q.split(/\s+/)[0];if(!this.options.ignoreAttributes&&Q.includes(" "))this.parseAttributes(Q,Y);let G=`</${U}>`,A=$.indexOf(G,_+1);if(A===-1)throw Error(`\u683C\u5F0F\u9519\u8BEF\uFF1A\u672A\u627E\u5230\u7ED3\u675F\u6807\u7B7E ${G}`);let H=$.slice(_+1,A);if(!H.trim())return{value:{[U]:Object.keys(Y).length>0?Y:""},end:A+G.length};if(!H.includes("<")){let X=this.parseValue(H);if(Object.keys(Y).length===0)return{value:{[U]:X},end:A+G.length};else return Y[this.options.textKey]=X,{value:{[U]:Y},end:A+G.length}}else{let X=0,K=[];while(X<H.length){let O=H.indexOf("<",X);if(O===-1){let I=H.slice(X).trim();if(I)K.push(I);break}if(O>X){let I=H.slice(X,O).trim();if(I)K.push(I)}let J=this.parseXmlElement(H,O),B=J.value;for(let[I,j]of Object.entries(B))this.addElement(Y,I,j);X=J.end}if(K.length>0){let O=K.join(" ");if(Object.keys(Y).length===0)return{value:{[U]:this.parseValue(O)},end:A+G.length};else Y[this.options.textKey]=this.parseValue(O)}return{value:{[U]:Y},end:A+G.length}}}addElement($,z,Z){if($[z]===void 0)$[z]=Z;else if(Array.isArray($[z]))$[z].push(Z);else $[z]=[$[z],Z]}parseValue($){if(!$||typeof $!=="string")return $;if(this.options.trimValues)$=$.trim();if(this.options.parseBooleans){if($==="true")return!0;if($==="false")return!1}if(this.options.parseNumbers){if(/^-?\d+$/.test($)){let z=parseInt($,10);if(z.toString()===$)return z}if(/^-?\d*\.\d+$/.test($)){let z=parseFloat($);if(!isNaN(z))return z}if(/^-?\d*\.?\d+e[+-]?\d+$/i.test($)){let z=parseFloat($);if(!isNaN(z))return z}}return this.decodeEntities($)}decodeEntities($){let z={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'"};return $.replace(/&[^;]+;/g,(Z)=>{return z[Z]||Z})}static parse($,z={}){return new k(z).parse($)}static parseWithAttributes($){return k.parse($,{ignoreAttributes:!1})}static parseIgnoreAttributes($){return k.parse($,{ignoreAttributes:!0})}static validate($){try{return k.parse($),!0}catch(z){return!1}}}var N0={number:"^\\d+$",integer:"^-?\\d+$",float:"^-?\\d+(\\.\\d+)?$",positive:"^[1-9]\\d*$",negative:"^-\\d+$",zero:"^0$",word:"^[a-zA-Z]+$",alphanumeric:"^[a-zA-Z0-9]+$",alphanumeric_:"^[a-zA-Z0-9_]+$",lowercase:"^[a-z]+$",uppercase:"^[A-Z]+$",chinese:"^[\\u4e00-\\u9fa5]+$",chinese_word:"^[\\u4e00-\\u9fa5a-zA-Z]+$",email:"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$",phone:"^1[3-9]\\d{9}$",url:"^https?://",ip:"^((25[0-5]|2[0-4]\\d|[01]?\\d\\d?)\\.){3}(25[0-5]|2[0-4]\\d|[01]?\\d\\d?)$",domain:"^(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\\.)+[a-zA-Z]{2,}$",uuid:"^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",hex:"^[0-9a-fA-F]+$",base64:"^[A-Za-z0-9+/=]+$",md5:"^[a-f0-9]{32}$",sha1:"^[a-f0-9]{40}$",sha256:"^[a-f0-9]{64}$",date:"^\\d{4}-\\d{2}-\\d{2}$",time:"^\\d{2}:\\d{2}:\\d{2}$",datetime:"^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}",year:"^\\d{4}$",month:"^(0[1-9]|1[0-2])$",day:"^(0[1-9]|[12]\\d|3[01])$",variable:"^[a-zA-Z_][a-zA-Z0-9_]*$",constant:"^[A-Z][A-Z0-9_]*$",package:"^[a-z][a-z0-9-]*$",id_card:"^\\d{17}[\\dXx]$",passport:"^[a-zA-Z0-9]{5,17}$",empty:"^$",notempty:".+"};class $0{regexAliases=N0;validate($,z,Z=[]){let _={code:0,fields:{}};if(!this.checkParams($,z,Z,_))return _;return this.checkRequiredFields($,z,Z,_),this.validateFields($,z,Z,_),_}checkParams($,z,Z,_){if(!$||typeof $!=="object"||Array.isArray($))return _.code=1,_.fields.error="\u6570\u636E\u5FC5\u987B\u662F\u5BF9\u8C61\u683C\u5F0F",!1;if(!z||typeof z!=="object")return _.code=1,_.fields.error="\u9A8C\u8BC1\u89C4\u5219\u5FC5\u987B\u662F\u5BF9\u8C61\u683C\u5F0F",!1;if(!Array.isArray(Z))return _.code=1,_.fields.error="\u5FC5\u4F20\u5B57\u6BB5\u5FC5\u987B\u662F\u6570\u7EC4\u683C\u5F0F",!1;return!0}checkRequiredFields($,z,Z,_){for(let Q of Z){let Y=$[Q];if(!(Q in $)||Y===void 0||Y===null||Y===""){_.code=1;let G=z[Q]?.name||Q;_.fields[Q]=`${G}(${Q})\u4E3A\u5FC5\u586B\u9879`}}}validateFields($,z,Z,_){for(let[Q,Y]of Object.entries(z)){if(!(Q in $)&&!Z.includes(Q))continue;if(_.fields[Q])continue;let U=$[Q],G=this.validateFieldValue(U,z[Q],Q);if(G)_.code=1,_.fields[Q]=G}}resolveRegexAlias($){if(!$||typeof $!=="string")return $;if($.startsWith("@")){let z=$.substring(1),Z=this.regexAliases[z];if(Z)return Z;return $}return $}validateFieldValue($,z,Z){let{name:_,type:Q,min:Y,max:U,regexp:G}=z;switch(G=this.resolveRegexAlias(G),Q.toLowerCase()){case"number":return this.validateNumber($,_,Y,U,G,Z);case"string":case"text":return this.validateString($,_,Y,U,G,Z);case"array_string":case"array_text":return this.validateArray($,_,Y,U,G,Z);default:return`\u5B57\u6BB5 ${Z} \u7684\u7C7B\u578B ${Q} \u4E0D\u652F\u6301`}}validateNumber($,z,Z,_,Q,Y){try{let U=$;if(typeof $==="string"){if(U=Number($),Number.isNaN(U)||!isFinite(U))return`${z}(${Y})\u5FC5\u987B\u662F\u6570\u5B57`}else if(typeof U!=="number"||Number.isNaN(U)||!isFinite(U))return`${z}(${Y})\u5FC5\u987B\u662F\u6570\u5B57`;if(Z!==null&&U<Z)return`${z}(${Y})\u4E0D\u80FD\u5C0F\u4E8E${Z}`;if(_!==null&&_>0&&U>_)return`${z}(${Y})\u4E0D\u80FD\u5927\u4E8E${_}`;if(Q&&Q.trim()!=="")try{if(!new RegExp(Q).test(String(U)))return`${z}(${Y})\u683C\u5F0F\u4E0D\u6B63\u786E`}catch(G){return`${z}(${Y})\u7684\u6B63\u5219\u8868\u8FBE\u5F0F\u683C\u5F0F\u9519\u8BEF`}return null}catch(U){return`${z}(${Y})\u9A8C\u8BC1\u51FA\u9519: ${U.message}`}}validateString($,z,Z,_,Q,Y){try{if(typeof $!=="string")return`${z}(${Y})\u5FC5\u987B\u662F\u5B57\u7B26\u4E32`;if(Z!==null&&$.length<Z)return`${z}(${Y})\u957F\u5EA6\u4E0D\u80FD\u5C11\u4E8E${Z}\u4E2A\u5B57\u7B26`;if(_!==null&&_>0&&$.length>_)return`${z}(${Y})\u957F\u5EA6\u4E0D\u80FD\u8D85\u8FC7${_}\u4E2A\u5B57\u7B26`;if(Q&&Q.trim()!=="")try{if(!new RegExp(Q).test($))return`${z}(${Y})\u683C\u5F0F\u4E0D\u6B63\u786E`}catch(U){return`${z}(${Y})\u7684\u6B63\u5219\u8868\u8FBE\u5F0F\u683C\u5F0F\u9519\u8BEF`}return null}catch(U){return`${z}(${Y})\u9A8C\u8BC1\u51FA\u9519: ${U.message}`}}validateArray($,z,Z,_,Q,Y){try{if(!Array.isArray($))return`${z}(${Y})\u5FC5\u987B\u662F\u6570\u7EC4`;if(Z!==null&&$.length<Z)return`${z}(${Y})\u81F3\u5C11\u9700\u8981${Z}\u4E2A\u5143\u7D20`;if(_!==null&&_>0&&$.length>_)return`${z}(${Y})\u6700\u591A\u53EA\u80FD\u6709${_}\u4E2A\u5143\u7D20`;if(Q&&Q.trim()!=="")try{let U=new RegExp(Q);for(let G of $)if(!U.test(String(G)))return`${z}(${Y})\u4E2D\u7684\u5143\u7D20"${G}"\u683C\u5F0F\u4E0D\u6B63\u786E`}catch(U){return`${z}(${Y})\u7684\u6B63\u5219\u8868\u8FBE\u5F0F\u683C\u5F0F\u9519\u8BEF`}return null}catch(U){return`${z}(${Y})\u9A8C\u8BC1\u51FA\u9519: ${U.message}`}}validateSingleValue($,z){let{name:Z,type:_,min:Q,max:Y,regexp:U,default:G}=z;if(U=this.resolveRegexAlias(U),$===void 0||$===null){if(G!==null){if((_==="array_string"||_==="array_text")&&typeof G==="string"){if(G==="[]")return{valid:!0,value:[],errors:[]};try{let X=JSON.parse(G);if(Array.isArray(X))return{valid:!0,value:X,errors:[]}}catch{return{valid:!0,value:[],errors:[]}}}if(_==="number"&&typeof G==="string"){let X=Number(G);if(!isNaN(X))return{valid:!0,value:X,errors:[]}}return{valid:!0,value:G,errors:[]}}if(_==="number")return{valid:!0,value:0,errors:[]};else if(_==="array_string"||_==="array_text")return{valid:!0,value:[],errors:[]};else if(_==="string"||_==="text")return{valid:!0,value:"",errors:[]}}let A=[],H=$;if(_==="number"&&typeof $==="string"){if(H=Number($),isNaN(H))return A.push(`${Z||"\u503C"}\u5FC5\u987B\u662F\u6709\u6548\u7684\u6570\u5B57`),{valid:!1,value:null,errors:A}}switch(_.toLowerCase()){case"number":if(typeof H!=="number"||Number.isNaN(H))A.push(`${Z||"\u503C"}\u5FC5\u987B\u662F\u6570\u5B57`);if(Q!==null&&H<Q)A.push(`${Z||"\u503C"}\u4E0D\u80FD\u5C0F\u4E8E${Q}`);if(Y!==null&&Y>0&&H>Y)A.push(`${Z||"\u503C"}\u4E0D\u80FD\u5927\u4E8E${Y}`);if(U&&U.trim()!=="")try{if(!new RegExp(U).test(String(H)))A.push(`${Z||"\u503C"}\u683C\u5F0F\u4E0D\u6B63\u786E`)}catch(X){A.push(`${Z||"\u503C"}\u7684\u6B63\u5219\u8868\u8FBE\u5F0F\u683C\u5F0F\u9519\u8BEF: ${X.message}`)}break;case"string":case"text":if(typeof H!=="string")A.push(`${Z||"\u503C"}\u5FC5\u987B\u662F\u5B57\u7B26\u4E32`);if(Q!==null&&H.length<Q)A.push(`${Z||"\u503C"}\u957F\u5EA6\u4E0D\u80FD\u5C11\u4E8E${Q}\u4E2A\u5B57\u7B26`);if(Y!==null&&Y>0&&H.length>Y)A.push(`${Z||"\u503C"}\u957F\u5EA6\u4E0D\u80FD\u8D85\u8FC7${Y}\u4E2A\u5B57\u7B26`);if(U&&U.trim()!=="")try{if(!new RegExp(U).test(H))A.push(`${Z||"\u503C"}\u683C\u5F0F\u4E0D\u6B63\u786E`)}catch{A.push(`${Z||"\u503C"}\u7684\u6B63\u5219\u8868\u8FBE\u5F0F\u683C\u5F0F\u9519\u8BEF`)}break;case"array_string":case"array_text":if(!Array.isArray(H))A.push(`${Z||"\u503C"}\u5FC5\u987B\u662F\u6570\u7EC4`);if(Q!==null&&H.length<Q)A.push(`${Z||"\u503C"}\u5143\u7D20\u6570\u91CF\u4E0D\u80FD\u5C11\u4E8E${Q}\u4E2A`);if(Y!==null&&Y>0&&H.length>Y)A.push(`${Z||"\u503C"}\u5143\u7D20\u6570\u91CF\u4E0D\u80FD\u8D85\u8FC7${Y}\u4E2A`);if(U&&U.trim()!=="")try{let X=new RegExp(U);for(let K of H)if(!X.test(String(K))){A.push(`${Z||"\u503C"}\u7684\u5143\u7D20\u683C\u5F0F\u4E0D\u6B63\u786E`);break}}catch{A.push(`${Z||"\u503C"}\u7684\u6B63\u5219\u8868\u8FBE\u5F0F\u683C\u5F0F\u9519\u8BEF`)}break}return{valid:A.length===0,value:A.length===0?H:null,errors:A}}static validate($,z,Z){let _=new $0;if(z&&"type"in z)return _.validateSingleValue($,z);return _.validate($,z,Z||[])}static isPassed($){if("valid"in $)return $.valid===!0;return $.code===0}static isFailed($){return $.code===1}static getFirstError($){if("valid"in $)return $.errors.length>0?$.errors[0]:null;if($.code===0)return null;if(!$.fields)return null;let z=Object.values($.fields);return z.length>0?z[0]:null}static getAllErrors($){if("valid"in $)return $.errors;if($.code===0)return[];if(!$.fields)return[];return Object.values($.fields)}static getErrorFields($){return $.code===0?[]:Object.keys($.fields)}}async function h0($){let z=$.request.headers.get("authorization");if(z&&z.startsWith("Bearer ")){let Z=z.substring(7);try{let _=await V.verify(Z);$.user=_}catch(_){$.user={}}}else $.user={}}var c=($)=>{return{headers:{"Access-Control-Allow-Origin":M.CORS_ALLOWED_ORIGIN==="*"?$.headers.get("origin"):M.CORS_ALLOWED_ORIGIN,"Access-Control-Allow-Methods":M.CORS_ALLOWED_METHODS,"Access-Control-Allow-Headers":M.CORS_ALLOWED_HEADERS,"Access-Control-Expose-Headers":M.CORS_EXPOSE_HEADERS,"Access-Control-Max-Age":M.CORS_MAX_AGE||86400,"Access-Control-Allow-Credentials":M.CORS_ALLOW_CREDENTIALS||"true"}}};function x0($){return new Response(null,{status:204,headers:$.headers})}function k0($,z){let Z=new URL(z.request.url);if(F($.fields)&&!l($.fields))z.body=m(Object.fromEntries(Z.searchParams),Object.keys($.fields));else z.body=Object.fromEntries(Z.searchParams)}async function j0($,z){try{let Z=z.request.headers.get("content-type")||"";if(Z.indexOf("json")!==-1)try{z.body=await z.request.json()}catch(_){z.body={}}else if(Z.indexOf("xml")!==-1){let _=await z.request.text(),Q=k.parse(_);z.body=Q?.xml?Q.xml:Q}else if(Z.indexOf("form-data")!==-1)z.body=await z.request.formData();else if(Z.indexOf("x-www-form-urlencoded")!==-1){let _=await z.request.text(),Q=new URLSearchParams(_);z.body=Object.fromEntries(Q)}else z.body={};if(F($.fields)&&!l($.fields))z.body=m(z.body,Object.keys($.fields));return!0}catch(Z){return W.error("\u5904\u7406\u8BF7\u6C42\u53C2\u6570\u65F6\u53D1\u751F\u9519\u8BEF",Z),!1}}function b0($,z,Z=!1){if($.auth===!1)return{code:0,msg:"",data:{}};if(!z.user?.id)return{code:1,msg:"\u672A\u767B\u5F55",data:{},login:"no"};if(z.user.roleCode==="dev")return{code:0,msg:"",data:{}};if(!Z)return{code:1,msg:"\u6CA1\u6709\u6743\u9650\u8BBF\u95EE\u6B64\u63A5\u53E3",data:{}};return{code:0,msg:"",data:{}}}async function f0($,z,Z){for await(let _ of $)try{if(typeof _?.onGet==="function")await _?.onGet(z,Z,Z.request)}catch(Q){W.error("\u63D2\u4EF6\u5904\u7406\u8BF7\u6C42\u65F6\u53D1\u751F\u9519\u8BEF",Q)}}function T$($,z=""){if(!$||!F($)&&!Array.isArray($))return $;let Z=z.split(",").map((Q)=>Q.trim()).filter((Q)=>Q.length>0),_={};for(let[Q,Y]of Object.entries($))if(!Z.includes(Q))_[Q]=Y;return _}function y0($,z){W.info({msg:"\u901A\u7528\u63A5\u53E3\u65E5\u5FD7",\u{8bf7}\u{6c42}\u{8def}\u{5f84}:$,\u{8bf7}\u{6c42}\u{65b9}\u{6cd5}:z.request.method,\u{7528}\u{6237}\u{4fe1}\u{606f}:z.user,\u{8bf7}\u{6c42}\u{53c2}\u{6570}:T$(z.body,M.LOG_EXCLUDE_FIELDS),\u{8017}\u{65f6}:Date.now()-z.startTime+"ms"})}var F$=new $0;function c0($,z){return F$.validate(z.body,$.fields,$.required)}async function v0($){let z=c($);try{return Response.json({code:0,msg:`${M.APP_NAME} \u63A5\u53E3\u670D\u52A1\u5DF2\u542F\u52A8`,data:{mode:M.NODE_ENV,timestamp:Date.now()}},{headers:z.headers})}catch(Z){W.error("\u6839\u8DEF\u5F84\u5904\u7406\u5931\u8D25",Z);let _="\u670D\u52A1\u5F02\u5E38",Q={};if(M.NODE_ENV==="development")Q={type:Z.constructor?.name||"Error",message:Z.message,stack:Z.stack};return Response.json(P(_,Q),{status:500,headers:z.headers})}}function g0($,z,Z){return async(_)=>{let Q=c(_),Y=null,U,G="";try{if(_.method==="OPTIONS")return x0(Q);Y={body:{},user:{},request:_,startTime:Date.now()};let A=new URL(_.url);if(G=`${_.method}${A.pathname}`,U=$.get(G),!U)return Response.json(P("\u63A5\u53E3\u4E0D\u5B58\u5728"),{headers:Q.headers});if(await h0(Y),_.method==="GET")k0(U,Y);else if(_.method==="POST"){if(!await j0(U,Y))return Response.json(P("\u65E0\u6548\u7684\u8BF7\u6C42\u53C2\u6570\u683C\u5F0F"),{headers:Q.headers})}await f0(z,Z,Y),y0(G,Y);let H=!1;if(U.auth===!0&&Y.user?.roleCode&&Y.user.roleCode!=="dev"){let J=`role:apis:${Y.user.roleCode}`;H=await Z.redis.sismember(J,G)===1}let X=b0(U,Y,H);if(X.code!==0)return Response.json(X,{headers:Q.headers});let K=c0(U,Y);if(K.code!==0)return Response.json(P("\u65E0\u6548\u7684\u8BF7\u6C42\u53C2\u6570\u683C\u5F0F",K.fields),{headers:Q.headers});let O=await U.handler(Z,Y,_);if(O instanceof Response)return O;if(O&&typeof O==="object"&&"code"in O){let J=JSON.stringify(O,(B,I)=>typeof I==="bigint"?I.toString():I);return new Response(J,{headers:{...Q.headers,"Content-Type":"application/json"}})}else return new Response(O,{headers:Q.headers})}catch(A){return W.error(U?`\u63A5\u53E3 [${U.name}] \u6267\u884C\u5931\u8D25`:"\u5904\u7406\u63A5\u53E3\u8BF7\u6C42\u65F6\u53D1\u751F\u9519\u8BEF",A),Response.json(P("\u5185\u90E8\u670D\u52A1\u5668\u9519\u8BEF"),{headers:Q.headers})}}}async function u0($){let z=c($),Z=new URL($.url),_=R(S,"public",Z.pathname);try{if($.method==="OPTIONS")return new Response(null,{status:204,headers:z.headers});let Q=Bun.file(_);if(await Q.exists())return new Response(Q,{headers:{"Content-Type":Q.type||"application/octet-stream",...z.headers}});else return Response.json(P("\u6587\u4EF6\u672A\u627E\u5230"),{status:404,headers:z.headers})}catch(Q){W.error("\u9759\u6001\u6587\u4EF6\u5904\u7406\u5931\u8D25",Q);let Y="\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25",U={};if(Q.message?.includes("EACCES")||Q.message?.includes("permission"))Y="\u6587\u4EF6\u8BBF\u95EE\u6743\u9650\u4E0D\u8DB3";else if(Q.message?.includes("ENOENT")||Q.message?.includes("not found"))Y="\u6587\u4EF6\u8DEF\u5F84\u4E0D\u5B58\u5728";if(M.NODE_ENV==="development")U={type:Q.constructor?.name||"Error",message:Q.message,stack:Q.stack,filePath:_};return Response.json(P(Y,U),{status:500,headers:z.headers})}}import{join as n0}from"path";import{existsSync as v,mkdirSync as S$}from"fs";var p0=["id","created_at","updated_at","deleted_at","state"],m0=["string","number","text","array_string","array_text"],L$=/^_?[a-z][a-z0-9]*(?:[A-Z][a-z0-9]*)*$/,P$=/^[\u4e00-\u9fa5a-zA-Z0-9 _-]+$/,o0=65535,d0=async function(){try{let $=[],z=!1;if(v(U0)){let _=await L(U0,"*.json",!1);for(let{filePath:Q}of _)$.push({file:Q,type:"project",typeName:"\u9879\u76EE"})}let Z=q();for(let _ of Z){let Q=E(_,"tables");if(!v(Q))continue;let Y=await L(Q,"*.json",!1);for(let{filePath:U}of Y)$.push({file:U,type:"addon",typeName:`\u7EC4\u4EF6${_}`,addonName:_})}for(let _ of $){let Q=f(_.file),Y=f(_.file,".json");try{if(!L$.test(Y)){W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6\u540D\u5FC5\u987B\u4F7F\u7528\u5C0F\u9A7C\u5CF0\u547D\u540D\uFF08\u4F8B\u5982 testCustomers.json\uFF09`),z=!0;continue}let G=(await import(_.file,{with:{type:"json"}})).default;for(let[A,H]of Object.entries(G)){if(typeof H!=="object"||H===null||Array.isArray(H)){W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u89C4\u5219\u5FC5\u987B\u4E3A\u5BF9\u8C61`),z=!0;continue}if(p0.includes(A))W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6\u5305\u542B\u4FDD\u7559\u5B57\u6BB5 ${A}\uFF0C`+`\u4E0D\u80FD\u5728\u8868\u5B9A\u4E49\u4E2D\u4F7F\u7528\u4EE5\u4E0B\u5B57\u6BB5: ${p0.join(", ")}`),z=!0;let X=H;if(!X.name||typeof X.name!=="string"){W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u7F3A\u5C11\u5FC5\u586B\u5B57\u6BB5 name \u6216\u7C7B\u578B\u9519\u8BEF`),z=!0;continue}if(!X.type||typeof X.type!=="string"){W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u7F3A\u5C11\u5FC5\u586B\u5B57\u6BB5 type \u6216\u7C7B\u578B\u9519\u8BEF`),z=!0;continue}if(X.min!==void 0&&!(X.min===null||typeof X.min==="number"))W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u5B57\u6BB5 min \u7C7B\u578B\u9519\u8BEF\uFF0C\u5FC5\u987B\u4E3A null \u6216\u6570\u5B57`),z=!0;if(X.max!==void 0&&!(X.max===null||typeof X.max==="number"))W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u5B57\u6BB5 max \u7C7B\u578B\u9519\u8BEF\uFF0C\u5FC5\u987B\u4E3A null \u6216\u6570\u5B57`),z=!0;if(X.detail!==void 0&&typeof X.detail!=="string")W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u5B57\u6BB5 detail \u7C7B\u578B\u9519\u8BEF\uFF0C\u5FC5\u987B\u4E3A\u5B57\u7B26\u4E32`),z=!0;if(X.index!==void 0&&typeof X.index!=="boolean")W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u5B57\u6BB5 index \u7C7B\u578B\u9519\u8BEF\uFF0C\u5FC5\u987B\u4E3A\u5E03\u5C14\u503C`),z=!0;if(X.unique!==void 0&&typeof X.unique!=="boolean")W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u5B57\u6BB5 unique \u7C7B\u578B\u9519\u8BEF\uFF0C\u5FC5\u987B\u4E3A\u5E03\u5C14\u503C`),z=!0;if(X.nullable!==void 0&&typeof X.nullable!=="boolean")W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u5B57\u6BB5 nullable \u7C7B\u578B\u9519\u8BEF\uFF0C\u5FC5\u987B\u4E3A\u5E03\u5C14\u503C`),z=!0;if(X.unsigned!==void 0&&typeof X.unsigned!=="boolean")W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u5B57\u6BB5 unsigned \u7C7B\u578B\u9519\u8BEF\uFF0C\u5FC5\u987B\u4E3A\u5E03\u5C14\u503C`),z=!0;if(X.regexp!==void 0&&X.regexp!==null&&typeof X.regexp!=="string")W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u5B57\u6BB5 regexp \u7C7B\u578B\u9519\u8BEF\uFF0C\u5FC5\u987B\u4E3A null \u6216\u5B57\u7B26\u4E32`),z=!0;let{name:K,type:O,min:J,max:B,default:I}=X;if(!P$.test(K))W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u5B57\u6BB5\u540D\u79F0 "${K}" \u683C\u5F0F\u9519\u8BEF\uFF0C`+"\u5FC5\u987B\u4E3A\u4E2D\u6587\u3001\u6570\u5B57\u3001\u5B57\u6BCD\u3001\u4E0B\u5212\u7EBF\u3001\u77ED\u6A2A\u7EBF\u3001\u7A7A\u683C"),z=!0;if(!m0.includes(O))W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u5B57\u6BB5\u7C7B\u578B "${O}" \u683C\u5F0F\u9519\u8BEF\uFF0C`+`\u5FC5\u987B\u4E3A${m0.join("\u3001")}\u4E4B\u4E00`),z=!0;if(J!==void 0&&B!==void 0&&J!==null&&B!==null){if(J>B)W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u6700\u5C0F\u503C "${J}" \u4E0D\u80FD\u5927\u4E8E\u6700\u5927\u503C "${B}"`),z=!0}if(O==="text"){if(J!==void 0&&J!==null)W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u7684 text \u7C7B\u578B\u6700\u5C0F\u503C\u5E94\u4E3A null\uFF0C\u5F53\u524D\u4E3A "${J}"`),z=!0;if(B!==void 0&&B!==null)W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u7684 text \u7C7B\u578B\u6700\u5927\u957F\u5EA6\u5E94\u4E3A null\uFF0C\u5F53\u524D\u4E3A "${B}"`),z=!0;if(I!==void 0&&I!==null)W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u4E3A text \u7C7B\u578B\uFF0C\u9ED8\u8BA4\u503C\u5FC5\u987B\u4E3A null\uFF0C\u5F53\u524D\u4E3A "${I}"`),z=!0}else if(O==="string"||O==="array_string"){if(B!==void 0&&(B===null||typeof B!=="number"))W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u4E3A ${O} \u7C7B\u578B\uFF0C`+`\u6700\u5927\u957F\u5EA6\u5FC5\u987B\u4E3A\u6570\u5B57\uFF0C\u5F53\u524D\u4E3A "${B}"`),z=!0;else if(B!==void 0&&B>o0)W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u6700\u5927\u957F\u5EA6 ${B} \u8D8A\u754C\uFF0C`+`${O} \u7C7B\u578B\u957F\u5EA6\u5FC5\u987B\u5728 1..${o0} \u8303\u56F4\u5185`),z=!0}else if(O==="number"){if(I!==void 0&&I!==null&&typeof I!=="number")W.warn(`${_.typeName}\u8868 ${Q} \u6587\u4EF6 ${A} \u4E3A number \u7C7B\u578B\uFF0C`+`\u9ED8\u8BA4\u503C\u5FC5\u987B\u4E3A\u6570\u5B57\u6216 null\uFF0C\u5F53\u524D\u4E3A "${I}"`),z=!0}}}catch(U){W.error(`${_.typeName}\u8868 ${Q} \u89E3\u6790\u5931\u8D25`,U),z=!0}}return!z}catch($){return W.error("\u6570\u636E\u8868\u5B9A\u4E49\u68C0\u67E5\u8FC7\u7A0B\u4E2D\u51FA\u9519",$),!1}},t0=async function(){try{let $=[];if(v(x)){let Z=await L(x);for(let{filePath:_,relativePath:Q}of Z)$.push({file:_,displayName:"\u7528\u6237",apiPath:Q})}let z=q();for(let Z of z){if(!h(Z,"apis"))continue;let _=E(Z,"apis"),Q=await L(_);for(let{filePath:Y,relativePath:U}of Q)$.push({file:Y,displayName:`\u7EC4\u4EF6${Z}`,apiPath:U})}for(let Z of $){let{apiPath:_}=Z;try{let U=(await import(Z.file.replace(/\\/g,"/"))).default;if(typeof U.name!=="string"||U.name.trim()===""){W.warn(`[${Z.displayName}] \u63A5\u53E3 ${_} \u7684 name \u5C5E\u6027\u5FC5\u987B\u662F\u975E\u7A7A\u5B57\u7B26\u4E32`);continue}if(typeof U.handler!=="function"){W.warn(`[${Z.displayName}] \u63A5\u53E3 ${_} \u7684 handler \u5C5E\u6027\u5FC5\u987B\u662F\u51FD\u6570`);continue}if(U.method&&!["GET","POST","PUT","DELETE","PATCH","HEAD","OPTIONS"].includes(U.method.toUpperCase()))W.warn(`[${Z.displayName}] \u63A5\u53E3 ${_} \u7684 method \u5C5E\u6027\u5FC5\u987B\u662F\u6709\u6548\u7684 HTTP \u65B9\u6CD5`);if(U.auth!==void 0&&typeof U.auth!=="boolean")W.warn(`[${Z.displayName}] \u63A5\u53E3 ${_} \u7684 auth \u5C5E\u6027\u5FC5\u987B\u662F\u5E03\u5C14\u503C (true=\u9700\u767B\u5F55, false=\u516C\u5F00)`);if(U.fields&&!F(U.fields))W.warn(`[${Z.displayName}] \u63A5\u53E3 ${_} \u7684 fields \u5C5E\u6027\u5FC5\u987B\u662F\u5BF9\u8C61`);if(U.required&&!Array.isArray(U.required))W.warn(`[${Z.displayName}] \u63A5\u53E3 ${_} \u7684 required \u5C5E\u6027\u5FC5\u987B\u662F\u6570\u7EC4`);if(U.required&&U.required.some((G)=>typeof G!=="string"))W.warn(`[${Z.displayName}] \u63A5\u53E3 ${_} \u7684 required \u5C5E\u6027\u5FC5\u987B\u662F\u5B57\u7B26\u4E32\u6570\u7EC4`)}catch(Q){W.error(`[${Z.displayName}] \u63A5\u53E3 ${_} \u89E3\u6790\u5931\u8D25`,Q)}}return!0}catch($){return W.error("API \u5B9A\u4E49\u68C0\u67E5\u8FC7\u7A0B\u4E2D\u51FA\u9519",$),!1}},s0=async function(){try{if(v(x)){let z=n0(x,"addon");if(v(z))return W.error("\u9879\u76EE apis \u76EE\u5F55\u4E0B\u4E0D\u80FD\u5B58\u5728\u540D\u4E3A addon \u7684\u76EE\u5F55\uFF0Caddon \u662F\u4FDD\u7559\u540D\u79F0\uFF0C\u7528\u4E8E\u7EC4\u4EF6\u63A5\u53E3\u8DEF\u7531"),!1}let $=n0(S,"logs");if(!v($))S$($,{recursive:!0});return!0}catch($){return W.error("\u9879\u76EE\u7ED3\u6784\u68C0\u67E5\u8FC7\u7A0B\u4E2D\u51FA\u9519",$),!1}};class E${apiRoutes=new Map;pluginLists=[];appContext;constructor(){this.appContext={}}async start(){let $=Bun.nanoseconds();if(await D0(this.apiRoutes),!await s0())W.error("\u9879\u76EE\u7ED3\u6784\u68C0\u67E5\u5931\u8D25\uFF0C\u7A0B\u5E8F\u9000\u51FA"),process.exit(1);if(!await d0())W.error("\u8868\u5B9A\u4E49\u68C0\u67E5\u5931\u8D25\uFF0C\u7A0B\u5E8F\u9000\u51FA"),process.exit(1);if(!await t0())W.error("API \u5B9A\u4E49\u68C0\u67E5\u5931\u8D25\uFF0C\u7A0B\u5E8F\u9000\u51FA"),process.exit(1);await E0({pluginLists:this.pluginLists,appContext:this.appContext});let Q=N($);return await this.startServer()}async startServer(){let $=Bun.nanoseconds(),z=Bun.serve({port:M.APP_PORT,hostname:M.APP_HOST,routes:{"/":v0,"/api/*":g0(this.apiRoutes,this.pluginLists,this.appContext),"/*":u0},error:(_)=>{return W.error("\u670D\u52A1\u542F\u52A8\u65F6\u53D1\u751F\u9519\u8BEF",_),Response.json({code:1,msg:"\u5185\u90E8\u670D\u52A1\u5668\u9519\u8BEF"})}}),Z=N($);return W.info(`${M.APP_NAME} \u542F\u52A8\u6210\u529F! `),W.info(`\u670D\u52A1\u5668\u542F\u52A8\u8017\u65F6: ${Z}`),W.info(`\u670D\u52A1\u5668\u76D1\u542C\u5730\u5740: http://${M.APP_HOST}:${M.APP_PORT}`),z}async listen(){let $=await this.start(),z=async(Z)=>{$.stop(!0),W.info("HTTP \u670D\u52A1\u5668\u5DF2\u505C\u6B62");try{await d.disconnect(),W.info("\u6570\u636E\u5E93\u8FDE\u63A5\u5DF2\u5173\u95ED")}catch(_){W.err("\u5173\u95ED\u6570\u636E\u5E93\u8FDE\u63A5\u65F6\u51FA\u9519:",_)}W.info("\u670D\u52A1\u5668\u5DF2\u4F18\u96C5\u5173\u95ED"),process.exit(0)};return process.on("SIGTERM",()=>z("SIGTERM")),process.on("SIGINT",()=>z("SIGINT")),$}}var F9={keysToSnake:y,keysToCamel:n,arrayKeysToCamel:p,pickFields:m,fieldClear:a,calcPerfTime:N,scanAddons:q,getAddonDir:E,addonDirExists:h};export{F9 as utils,X$ as coreDir,d0 as checkTable,s0 as checkApp,t0 as checkApi,M$ as Yes,e as RedisHelper,P as No,W as Logger,V as Jwt,M as Env,o as DbHelper,d as Database,J0 as Cipher,E$ as Befly};
