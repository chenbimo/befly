# 类型定义参考

Befly 提供完整的 TypeScript 类型定义，覆盖所有核心功能。

## 核心类型

### BeflyContext

应用上下文，包含所有插件提供的功能。

```typescript
interface BeflyContext {
    // 数据库管理器
    db: SqlHelper;

    // Redis 助手
    redis: typeof RedisHelper;

    // 日志记录器
    logger: typeof Logger;

    // 数据处理工具
    tool: Tool;

    // 自定义插件
    [key: string]: any;
}
```

### ApiRoute

API 路由定义。

```typescript
interface ApiRoute {
    /** HTTP 方法 */
    method: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH' | 'OPTIONS';

    /** 接口名称 */
    name: string;

    /** 认证要求：false=公开，true=需登录，['admin']=需特定角色 */
    auth: boolean | string[];

    /** 字段规则定义 */
    fields: Record<string, string>;

    /** 必填字段列表 */
    required: string[];

    /** 处理函数 */
    handler: ApiHandler;
}
```

### ApiHandler

API 处理器函数类型。

```typescript
type ApiHandler = (befly: BeflyContext, ctx: RequestContext, req: Request) => Promise<ApiResponse>;

interface RequestContext {
    req: Request;
    url: URL;
    pathname: string;
    query: URLSearchParams;
    body: any;
    headers: Headers;
}

interface ApiResponse {
    code: 0 | 1;
    msg: string;
    data: any;
}
```

## 数据库类型

### SqlHelper

数据库管理器。

```typescript
class SqlHelper {
    /** 查询单条数据 */
    getOne<T = any>(options: QueryOptions): Promise<T | null>;

    /** 查询列表（带分页） */
    getList<T = any>(options: QueryOptions): Promise<ListResult<T>>;

    /** 查询所有数据 */
    getAll<T = any>(options: Omit<QueryOptions, 'page' | 'limit'>): Promise<T[]>;

    /** 插入数据 */
    insData(options: InsertOptions): Promise<number>;

    /** 更新数据 */
    updData(options: UpdateOptions): Promise<number>;

    /** 删除数据 */
    delData(options: DeleteOptions): Promise<number>;

    /** 执行事务 */
    trans<T = any>(callback: TransactionCallback<T>): Promise<T>;

    /** 执行原始 SQL */
    query(sql: string, params?: any[]): Promise<any>;
}
```

### QueryOptions

查询选项。

```typescript
interface QueryOptions {
    /** 表名 */
    table: string;

    /** 查询字段，默认 ['*'] */
    fields?: string[];

    /** WHERE 条件 */
    where?: WhereConditions;

    /** 排序，如 'id DESC' */
    orderBy?: string;

    /** 页码（从 1 开始） */
    page?: number;

    /** 每页数量 */
    limit?: number;

    /** 是否包含已删除数据 */
    includeDeleted?: boolean;

    /** 自定义 state 条件 */
    customState?: WhereConditions;
}
```

### WhereConditions

WHERE 条件对象。

```typescript
type WhereConditions = {
    [field: string]: string | number | boolean | null | WhereOperator;
};

interface WhereOperator {
    /** 大于 */
    $gt?: number;

    /** 大于等于 */
    $gte?: number;

    /** 小于 */
    $lt?: number;

    /** 小于等于 */
    $lte?: number;

    /** 不等于 */
    $ne?: any;

    /** 在...之中 */
    $in?: any[];

    /** 不在...之中 */
    $nin?: any[];

    /** LIKE 模糊匹配 */
    $like?: string;

    /** BETWEEN...AND */
    $between?: [number, number];

    /** IS NULL */
    $null?: boolean;
}
```

### ListResult

列表查询结果。

```typescript
interface ListResult<T = any> {
    /** 数据列表 */
    list: T[];

    /** 总条数 */
    total: number;

    /** 当前页码 */
    page: number;

    /** 每页数量 */
    limit: number;

    /** 总页数 */
    pages: number;
}
```

### InsertOptions

插入选项。

```typescript
interface InsertOptions {
    /** 表名 */
    table: string;

    /** 插入数据 */
    data: Record<string, any>;

    /** 是否自动生成 ID，默认 true */
    autoId?: boolean;

    /** 是否自动添加时间戳，默认 true */
    autoTimestamp?: boolean;

    /** 是否自动添加 state 字段，默认 true */
    autoState?: boolean;
}
```

### UpdateOptions

更新选项。

```typescript
interface UpdateOptions {
    /** 表名 */
    table: string;

    /** 更新数据 */
    data: Record<string, any>;

    /** WHERE 条件 */
    where: WhereConditions;

    /** 是否自动更新时间戳，默认 true */
    autoTimestamp?: boolean;

    /** 是否包含已删除数据，默认 false */
    includeDeleted?: boolean;
}
```

### DeleteOptions

删除选项。

```typescript
interface DeleteOptions {
    /** 表名 */
    table: string;

    /** WHERE 条件 */
    where: WhereConditions;

    /** 是否物理删除，默认 false（软删除） */
    hard?: boolean;

    /** 是否自动更新时间戳，默认 true */
    autoTimestamp?: boolean;
}
```

### TransactionCallback

事务回调函数。

```typescript
type TransactionCallback<T = any> = (trans: SqlHelper) => Promise<T>;

// 使用示例
await befly.db.trans(async (trans) => {
    await trans.insData({ table: 'order', data: orderData });
    await trans.updData({ table: 'product', data: { stock: newStock }, where: { id: productId } });
    return { success: true };
});
```

## SQL 构建器类型

### SqlBuilder

SQL 查询构建器。

```typescript
class SqlBuilder {
    /** 设置 SELECT 字段 */
    select(fields: string[]): SqlBuilder;

    /** 设置 FROM 表 */
    from(table: string): SqlBuilder;

    /** 设置 WHERE 条件 */
    where(conditions: WhereConditions): SqlBuilder;

    /** 设置 ORDER BY */
    orderBy(order: string): SqlBuilder;

    /** 设置 LIMIT */
    limit(limit: number): SqlBuilder;

    /** 设置 OFFSET */
    offset(offset: number): SqlBuilder;

    /** 生成 SELECT 语句 */
    toSelectSql(): SqlQuery;

    /** 生成 INSERT 语句 */
    toInsertSql(data: Record<string, any>): SqlQuery;

    /** 生成 UPDATE 语句 */
    toUpdateSql(data: Record<string, any>): SqlQuery;

    /** 生成 DELETE 语句 */
    toDeleteSql(): SqlQuery;
}
```

### SqlQuery

SQL 查询对象。

```typescript
interface SqlQuery {
    /** SQL 语句 */
    sql: string;

    /** 参数列表 */
    params: any[];
}
```

## Redis 类型

### RedisHelper

Redis 助手对象。

```typescript
const RedisHelper = {
    /** 设置对象到 Redis */
    setObject<T = any>(key: string, obj: T, ttl?: number | null): Promise<string | null>;

    /** 从 Redis 获取对象 */
    getObject<T = any>(key: string): Promise<T | null>;

    /** 从 Redis 删除对象 */
    delObject(key: string): Promise<void>;

    /** 生成基于时间的唯一 ID */
    genTimeID(): Promise<number>;

    /** 设置字符串值 */
    setString(key: string, value: string, ttl?: number | null): Promise<string | null>;

    /** 获取字符串值 */
    getString(key: string): Promise<string | null>;

    /** 检查键是否存在 */
    exists(key: string): Promise<number>;

    /** 设置过期时间 */
    expire(key: string, seconds: number): Promise<number>;

    /** 获取剩余过期时间 */
    ttl(key: string): Promise<number>;
};
```

## 验证器类型

### Validator

数据验证器。

```typescript
class Validator {
    /** 验证数据 */
    static validate(value: any, rule: string): ValidationResult;

    /** 判断验证是否通过 */
    static isPassed(result: ValidationResult): boolean;

    /** 获取第一个错误 */
    static getFirstError(result: ValidationResult): string | null;

    /** 获取所有错误 */
    static getAllErrors(result: ValidationResult): string[];
}
```

### ValidationResult

验证结果。

```typescript
interface ValidationResult {
    /** 是否有效 */
    valid: boolean;

    /** 处理后的值 */
    value: any;

    /** 错误列表 */
    errors: string[];
}
```

### ParsedFieldRule

解析后的字段规则。

```typescript
interface ParsedFieldRule {
    /** 显示名 */
    name: string;

    /** 字段类型 */
    type: 'string' | 'number' | 'text' | 'array';

    /** 最小值/长度 */
    min: string;

    /** 最大值/长度 */
    max: string;

    /** 默认值 */
    default: string;

    /** 是否索引 */
    index: string;

    /** 正则约束 */
    regex: string;
}
```

## JWT 类型

### Jwt

JWT 工具类。

```typescript
class Jwt {
    /** 签名 JWT */
    static sign(payload: JwtPayload, secret: string, expiresIn: string): Promise<string>;

    /** 验证 JWT */
    static verify(token: string, secret: string): Promise<JwtPayload>;

    /** 解码 JWT（不验证） */
    static decode(token: string): Promise<JwtPayload>;

    /** 检查角色 */
    static hasRole(payload: JwtPayload, role: string): boolean;

    /** 检查任一角色 */
    static hasAnyRole(payload: JwtPayload, roles: string[]): boolean;

    /** 检查权限 */
    static hasPermission(payload: JwtPayload, permission: string): boolean;

    /** 检查所有权限 */
    static hasAllPermissions(payload: JwtPayload, permissions: string[]): boolean;

    /** 便捷方法：创建 token */
    static create(payload: JwtPayload): Promise<string>;

    /** 便捷方法：检查 token */
    static check(token: string): Promise<JwtPayload>;

    /** 便捷方法：解析 token */
    static parse(token: string): Promise<JwtPayload>;
}
```

### JwtPayload

JWT 载荷。

```typescript
interface JwtPayload {
    /** 用户 ID */
    userId?: string;

    /** 用户名 */
    username?: string;

    /** 角色 */
    role?: string;

    /** 权限列表 */
    permissions?: string[];

    /** 签发时间 */
    iat?: number;

    /** 过期时间 */
    exp?: number;

    /** 其他自定义字段 */
    [key: string]: any;
}
```

## 加密类型

### Crypto

加密工具类。

```typescript
class Crypto {
    /** MD5 哈希 */
    static md5(data: string, encoding?: EncodingType): string;

    /** SHA256 哈希 */
    static sha256(data: string, encoding?: EncodingType): string;

    /** HMAC-MD5 */
    static hmacMd5(data: string, key: string, encoding?: EncodingType): string;

    /** HMAC-SHA256 */
    static hmacSha256(data: string, key: string, encoding?: EncodingType): string;

    /** 密码加密 */
    static hashPassword(password: string): Promise<string>;

    /** 密码验证 */
    static verifyPassword(password: string, hash: string): Promise<boolean>;

    /** Base64 编码 */
    static base64Encode(data: string): string;

    /** Base64 解码 */
    static base64Decode(data: string): string;

    /** 生成随机字符串 */
    static randomString(length: number): string;
}
```

### EncodingType

编码类型。

```typescript
type EncodingType = 'hex' | 'base64' | 'base64url';
```

### HashAlgorithm

哈希算法。

```typescript
type HashAlgorithm = 'md5' | 'sha1' | 'sha256' | 'sha512';
```

## 插件类型

### Plugin

插件定义。

```typescript
interface Plugin {
    /** 插件名称 */
    name?: string;

    /** 依赖的插件列表 */
    after?: string[];

    /** 初始化函数 */
    onInit?: (befly: BeflyContext) => Promise<any>;
}
```

## 工具类型

### Tool

数据处理工具类。

```typescript
class Tool {
    /** 处理更新数据 */
    updData(data: Record<string, any>, now?: number): Promise<Record<string, any>>;

    /** 处理插入数据 */
    insData(data: Record<string, any> | Record<string, any>[], now?: number): Promise<Record<string, any> | Record<string, any>[]>;

    /** 处理删除数据 */
    delData(now?: number): Promise<Record<string, any>>;

    /** 批量生成 ID */
    genIds(count: number): Promise<number[]>;

    /** 清理数据对象 */
    cleanData(data: Record<string, any>, removeNull?: boolean, removeEmptyString?: boolean): Record<string, any>;

    /** 合并数据对象 */
    mergeData(target: Record<string, any>, ...sources: Record<string, any>[]): Record<string, any>;

    /** 提取指定字段 */
    pickFields(data: Record<string, any>, fields: string[]): Record<string, any>;

    /** 排除指定字段 */
    omitFields(data: Record<string, any>, fields: string[]): Record<string, any>;

    /** 重命名字段 */
    renameFields(data: Record<string, any>, mapping: Record<string, string>): Record<string, any>;

    /** 转换字段类型 */
    convertFields(data: Record<string, any>, conversions: Record<string, 'number' | 'string' | 'boolean'>): Record<string, any>;
}
```

## 使用示例

### 完整的类型安全接口

```typescript
import { Api, Yes, No } from 'befly';
import type { BeflyContext } from 'befly/types';
import type { ListResult } from 'befly/utils';

// 定义数据模型
interface User {
    id: number;
    username: string;
    email: string;
    role: string;
    createdAt: number;
    updatedAt: number;
}

// 定义查询参数
interface GetUsersParams {
    page?: number;
    limit?: number;
    role?: string;
}

export default Api.POST(
    '获取用户列表',
    ['admin'], // 仅管理员可访问
    {
        page: '页码⚡number⚡1⚡9999⚡1⚡0⚡null',
        limit: '每页数量⚡number⚡1⚡100⚡10⚡0⚡null',
        role: '角色⚡string⚡1⚡20⚡null⚡0⚡^(admin|user|guest)$'
    },
    [],
    async (befly: BeflyContext, ctx: any) => {
        try {
            const params = ctx.body as GetUsersParams;

            // 类型安全的数据库查询
            const result: ListResult<User> = await befly.db.getList<User>({
                table: 'user',
                where: params.role ? { role: params.role } : {},
                page: params.page || 1,
                limit: params.limit || 10,
                orderBy: 'created_at DESC'
            });

            // result.list 的类型为 User[]
            return Yes<ListResult<User>>('查询成功', result);
        } catch (error: any) {
            befly.logger.error({
                msg: '查询用户失败',
                error: error.message
            });
            return No('查询失败', { error: error.message });
        }
    }
);
```
