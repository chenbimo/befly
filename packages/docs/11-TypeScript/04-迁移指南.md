# JavaScript 迁移到 TypeScript

本指南帮助你将现有的 Befly JavaScript 项目逐步迁移到 TypeScript。

## 迁移策略

### 渐进式迁移

不需要一次性迁移所有代码，可以采用渐进式策略：

1. **混合模式**：JavaScript 和 TypeScript 文件共存
2. **优先级迁移**：先迁移核心模块，再迁移业务代码
3. **按模块迁移**：一次迁移一个模块，确保功能正常

### 迁移优先级

建议按以下顺序迁移：

```
1. 类型定义 (types/) - 定义所有接口和类型
2. 工具函数 (utils/) - 无依赖的工具函数
3. 插件 (plugins/) - 核心插件
4. API 接口 (apis/) - 业务接口
5. 脚本 (scripts/) - 管理脚本
6. 入口文件 (main.ts) - 最后迁移
```

## 第一步：准备工作

### 1. 更新 package.json

```json
{
    "name": "your-project",
    "version": "3.0.0",
    "main": "main.ts",
    "types": "main.ts",
    "scripts": {
        "dev": "bun run main.ts",
        "prod": "bun run main.ts",
        "test": "bun test"
    },
    "dependencies": {
        "befly": "^3.0.0"
    },
    "devDependencies": {
        "@types/bun": "latest"
    },
    "engines": {
        "bun": ">=1.0.0"
    }
}
```

### 2. 创建 tsconfig.json

```json
{
    "compilerOptions": {
        "target": "ESNext",
        "module": "ESNext",
        "lib": ["ESNext"],
        "moduleResolution": "bundler",
        "allowImportingTsExtensions": true,
        "noEmit": true,
        "strict": true,
        "skipLibCheck": true,
        "types": ["bun-types"],
        "paths": {
            "befly": ["./node_modules/befly/main.ts"],
            "befly/*": ["./node_modules/befly/*"]
        }
    },
    "include": ["**/*.ts"],
    "exclude": ["node_modules"]
}
```

### 3. 创建类型定义目录

```bash
mkdir types
```

## 第二步：定义数据模型

### 1. 创建基础类型文件

创建 `types/models.ts`：

```typescript
// 基础实体接口（所有表共有的字段）
export interface BaseEntity {
    id: number;
    createdAt: number;
    updatedAt: number;
    deletedAt: number | null;
    state: number;
}

// 用户
export interface User extends BaseEntity {
    username: string;
    email: string;
    password: string;
    role: UserRole;
}

export type UserRole = 'admin' | 'user' | 'guest';

// 产品
export interface Product extends BaseEntity {
    name: string;
    price: number;
    stock: number;
    categoryId: number;
    tags: string[];
    description: string;
}

// 订单
export interface Order extends BaseEntity {
    userId: number;
    productId: number;
    quantity: number;
    totalPrice: number;
    status: OrderStatus;
}

export type OrderStatus = 'pending' | 'paid' | 'shipped' | 'completed' | 'cancelled';
```

### 2. 创建 API 类型文件

创建 `types/api.ts`：

```typescript
// API 请求参数基础接口
export interface PaginationParams {
    page?: number;
    limit?: number;
}

// API 响应基础接口
export interface ApiResponse<T = any> {
    code: 0 | 1;
    msg: string;
    data: T;
}

// 列表响应
export interface ListResponse<T = any> {
    list: T[];
    total: number;
    page: number;
    limit: number;
    pages: number;
}
```

### 3. 创建索引文件

创建 `types/index.ts`：

```typescript
export * from './models';
export * from './api';
```

## 第三步：迁移工具函数

### JavaScript 版本

```javascript
// utils/format.js
export function formatDate(timestamp, format = 'datetime') {
    const date = new Date(timestamp);

    switch (format) {
        case 'date':
            return date.toISOString().split('T')[0];
        case 'time':
            return date.toISOString().split('T')[1].split('.')[0];
        default:
            return date.toISOString().replace('T', ' ').split('.')[0];
    }
}

export function formatPrice(price) {
    return `¥${(price / 100).toFixed(2)}`;
}
```

### TypeScript 版本

```typescript
// utils/format.ts
export function formatDate(timestamp: number, format: 'date' | 'time' | 'datetime' = 'datetime'): string {
    const date = new Date(timestamp);

    switch (format) {
        case 'date':
            return date.toISOString().split('T')[0];
        case 'time':
            return date.toISOString().split('T')[1].split('.')[0];
        case 'datetime':
        default:
            return date.toISOString().replace('T', ' ').split('.')[0];
    }
}

export function formatPrice(price: number): string {
    return `¥${(price / 100).toFixed(2)}`;
}
```

## 第四步：迁移 API 接口

### JavaScript 版本

```javascript
// apis/user/list.js
import { Api, Yes, No } from 'befly';

export default Api.POST(
    '获取用户列表',
    ['admin'],
    {
        page: '页码⚡number⚡1⚡9999⚡1⚡0⚡null',
        limit: '每页数量⚡number⚡1⚡100⚡10⚡0⚡null',
        role: '角色⚡string⚡0⚡20⚡null⚡0⚡^(admin|user|guest)$'
    },
    [],
    async (befly, ctx) => {
        try {
            const { page = 1, limit = 10, role } = ctx.body;

            const where = {};
            if (role) where.role = role;

            const result = await befly.db.getList({
                table: 'user',
                fields: ['id', 'username', 'email', 'role', 'created_at'],
                where,
                page,
                limit,
                orderBy: 'created_at DESC'
            });

            return Yes('查询成功', result);
        } catch (error) {
            befly.logger.error({ msg: '查询用户失败', error: error.message });
            return No('查询失败');
        }
    }
);
```

### TypeScript 版本

```typescript
// apis/user/list.ts
import { Api, Yes, No } from 'befly';
import type { BeflyContext } from 'befly/types';
import type { User, PaginationParams, ListResponse } from '../../types';

// 请求参数类型
interface GetUsersRequest extends PaginationParams {
    role?: string;
}

// 响应数据类型（仅包含公开字段）
type PublicUser = Pick<User, 'id' | 'username' | 'email' | 'role' | 'createdAt'>;

export default Api.POST(
    '获取用户列表',
    ['admin'],
    {
        page: '页码⚡number⚡1⚡9999⚡1⚡0⚡null',
        limit: '每页数量⚡number⚡1⚡100⚡10⚡0⚡null',
        role: '角色⚡string⚡0⚡20⚡null⚡0⚡^(admin|user|guest)$'
    },
    [],
    async (befly: BeflyContext, ctx: any) => {
        try {
            const params = ctx.body as GetUsersRequest;

            const where: any = {};
            if (params.role) where.role = params.role;

            const result = await befly.db.getList<User>({
                table: 'user',
                fields: ['id', 'username', 'email', 'role', 'created_at'],
                where,
                page: params.page || 1,
                limit: params.limit || 10,
                orderBy: 'created_at DESC'
            });

            return Yes<ListResponse<PublicUser>>('查询成功', result);
        } catch (error: any) {
            befly.logger.error({ msg: '查询用户失败', error: error.message });
            return No('查询失败');
        }
    }
);
```

## 第五步：迁移插件

### JavaScript 版本

```javascript
// plugins/cache.js
export default {
    name: 'cache',

    async onInit(befly) {
        return {
            async get(key) {
                return await befly.redis.getObject(key);
            },

            async set(key, value, ttl) {
                await befly.redis.setObject(key, value, ttl);
            },

            async del(key) {
                await befly.redis.delObject(key);
            }
        };
    }
};
```

### TypeScript 版本

```typescript
// plugins/cache.ts
import type { BeflyContext } from 'befly/types';

interface CachePlugin {
    get<T = any>(key: string): Promise<T | null>;
    set<T = any>(key: string, value: T, ttl?: number): Promise<void>;
    del(key: string): Promise<void>;
}

export default {
    name: 'cache',

    async onInit(befly: BeflyContext): Promise<CachePlugin> {
        return {
            async get<T = any>(key: string): Promise<T | null> {
                return await befly.redis.getObject<T>(key);
            },

            async set<T = any>(key: string, value: T, ttl?: number): Promise<void> {
                await befly.redis.setObject<T>(key, value, ttl);
            },

            async del(key: string): Promise<void> {
                await befly.redis.delObject(key);
            }
        };
    }
};

// 扩展 BeflyContext 类型
declare module 'befly/types' {
    interface BeflyContext {
        cache: CachePlugin;
    }
}
```

## 第六步：迁移入口文件

### JavaScript 版本

```javascript
// main.js
import { Server } from 'befly';

await Server({
    name: 'My API',
    port: 3000
});
```

### TypeScript 版本

```typescript
// main.ts
import { Server } from 'befly';

await Server({
    name: 'My API',
    port: 3000
});
```

## 常见迁移问题

### 1. ctx.body 没有类型

**问题**：

```typescript
async (befly, ctx) => {
    const { username } = ctx.body; // ❌ ctx.body 是 any
};
```

**解决**：

```typescript
interface RequestBody {
    username: string;
}

async (befly: BeflyContext, ctx: any) => {
    const body = ctx.body as RequestBody;
    const { username } = body; // ✅ 有类型提示
};
```

### 2. 数据库查询结果类型

**问题**：

```typescript
const user = await befly.db.getOne({
    table: 'user',
    where: { id: 1 }
});
// user 是 any
```

**解决**：

```typescript
import type { User } from '../types/models';

const user = await befly.db.getOne<User>({
    table: 'user',
    where: { id: 1 }
});
// user 是 User | null
```

### 3. JSON.parse 结果类型

**问题**：

```typescript
const data = JSON.parse(jsonString);
// data 是 any
```

**解决**：

```typescript
interface UserData {
    username: string;
    email: string;
}

const data = JSON.parse(jsonString) as UserData;
// data 是 UserData（但运行时需要验证）
```

### 4. 错误对象类型

**问题**：

```typescript
try {
    // ...
} catch (error) {
    console.log(error.message); // ❌ error 是 unknown
}
```

**解决**：

```typescript
try {
    // ...
} catch (error: unknown) {
    if (error instanceof Error) {
        console.log(error.message); // ✅ 类型安全
    }
}
```

## 迁移检查清单

完成迁移后，检查以下项目：

### 文件重命名

- [ ] 所有 `.js` 文件已重命名为 `.ts`
- [ ] 导入路径已更新（去除 `.js` 后缀）

### 类型定义

- [ ] 已创建 `types/` 目录
- [ ] 已定义所有数据模型类型
- [ ] 已定义 API 请求/响应类型

### 代码更新

- [ ] 所有函数参数都有类型
- [ ] 所有函数返回值都有类型
- [ ] 所有接口都指定了 `BeflyContext` 类型
- [ ] 数据库查询使用了泛型类型

### 配置文件

- [ ] 已创建 `tsconfig.json`
- [ ] `package.json` 的 `main` 字段指向 `.ts` 文件
- [ ] 已添加 `@types/bun` 依赖

### 测试

- [ ] 所有测试文件已迁移
- [ ] 运行 `bun test` 无错误
- [ ] 运行 `bun run main.ts` 能正常启动

### IDE 支持

- [ ] VS Code 能正确识别类型
- [ ] 智能提示正常工作
- [ ] 没有红色波浪线错误

## 迁移示例项目

完整的迁移示例请参考：

```
tpl/
├── types/
│   ├── index.ts
│   ├── models.ts
│   └── api.ts
├── utils/
│   ├── format.ts
│   └── validate.ts
├── plugins/
│   └── cache.ts
├── apis/
│   ├── user/
│   │   ├── login.ts
│   │   ├── register.ts
│   │   └── list.ts
│   └── product/
│       ├── list.ts
│       └── detail.ts
├── main.ts
├── package.json
└── tsconfig.json
```

## 渐进式迁移技巧

### 1. 使用 `// @ts-check` 注释

在 JavaScript 文件顶部添加：

```javascript
// @ts-check
// 启用 TypeScript 类型检查（但仍然是 JS 文件）

/**
 * @param {number} a
 * @param {number} b
 * @returns {number}
 */
export function add(a, b) {
    return a + b;
}
```

### 2. 使用 JSDoc 添加类型

```javascript
/**
 * @typedef {Object} User
 * @property {number} id
 * @property {string} username
 * @property {string} email
 */

/**
 * @param {User} user
 * @returns {Promise<void>}
 */
async function saveUser(user) {
    // ...
}
```

### 3. 混合使用 JS 和 TS

在迁移过程中，JavaScript 和 TypeScript 文件可以共存：

```typescript
// utils/format.ts (TypeScript)
export function formatDate(timestamp: number): string {
    // ...
}

// apis/user/list.js (JavaScript，暂未迁移)
import { formatDate } from '../../utils/format'; // ✅ 可以导入 TS 文件

export default Api.POST(/* ... */);
```

## 总结

迁移到 TypeScript 的关键步骤：

1. **准备配置**：创建 `tsconfig.json` 和更新 `package.json`
2. **定义类型**：先定义所有数据模型和 API 类型
3. **逐步迁移**：从工具函数开始，逐步迁移到业务代码
4. **测试验证**：确保每次迁移后功能正常
5. **利用 IDE**：充分利用 VS Code 的 TypeScript 支持

迁移完成后，你将获得：

- ✅ 编译时类型检查
- ✅ 完整的智能提示
- ✅ 更好的代码可维护性
- ✅ 更高的开发效率
