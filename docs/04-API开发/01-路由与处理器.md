# 路由与处理器

Befly 的 API 文件位于 `<project>/apis/**` 目录（模板工程为 `tpl/apis/**`）。每个文件导出一个由 `Api.GET`/`Api.POST` 创建的处理器。

## 基本形态

```js
import { Api, RYes, RNo } from 'befly';

export default Api.POST(
    '测试接口', // name：显示名
    false, // auth：true|false|字符串|字符串数组
    {
        /* 字段规则 */
    }, // fields：用于校验的字段定义
    [
        /* 必填字段 */
    ], // required：字符串数组
    async (befly, ctx, req) => {
        // 你的业务逻辑
        return RYes('OK');
    }
);
```

-   路由会被自动注册为：`<METHOD>/api/app/<相对路径>`（core 内置接口则为 `/api/core/...`）。
-   ctx 对象包含：
    -   `ctx.headers` 请求头
    -   `ctx.body` 解析后的请求体（GET/POST 自动处理 json/xml/form 等）
    -   `ctx.user` 当带有 `Authorization: Bearer <token>` 时自动解析并注入

## auth 说明

-   `true`：需要用户登录（ctx.user 有 id）
-   `false`：无需登录
-   `'role'`：需要指定单角色，如 `'admin'`
-   `['roleA', 'roleB']`：角色在列表内之一即可

## 参数校验与拦截

-   框架在进入 handler 前会自动：
    1. 运行插件 `onGet` 钩子（如日志、鉴权前置等）
    2. 校验 `fields` 和 `required`，失败将直接返回 `RNo('无效的请求参数格式', fields)`

## 返回格式

-   成功：`RYes(message, data)` → `{ code:0, msg: message, data }`
-   失败：`RNo(message, error?)` → `{ code:-1, msg: message, error? }`

## 路由示例

-   文件：`tpl/apis/test/hi.js`
-   方法：POST
-   访问：`POST /api/app/test/hi`
-   若该接口 `auth:true`，需携带 Bearer JWT；否则返回“未登录/没有权限”。
