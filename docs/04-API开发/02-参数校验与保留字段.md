# 参数校验与保留字段

Befly 使用 `utils/validate.js` 进行统一的参数校验。每个接口提供 `fields` 与 `required`，框架在进入 handler 前自动校验。

## fields 规则

-   采用“字段规则表”的子集；建议与你在 `tables/*.json` 中的定义保持一致。
-   保留字段禁止出现在自定义规则中：`id, created_at, updated_at, deleted_at, state`。
-   支持正则约束，枚举可用正则实现：如 `^(active|inactive|pending)$`。

## required 必填

-   为字符串数组；每个成员必须在 `fields` 中存在。
-   校验失败会返回 `{ code:-1, msg:'无效的请求参数格式', fields: {...} }`。

## GET/POST 参数来源

-   GET：取 URL 查询参数（按 fields 做裁剪）。
-   POST：自动识别 `application/json`、`application/xml`、`multipart/form-data`、`x-www-form-urlencoded`，并按 fields 裁剪。

## 最佳实践

-   对外接口尽量在 `fields` 中列举允许的字段，防止多余/可疑字段进入后端。
-   在 `AGENTS.md` 的“数据验证系统”部分有更多说明与示例。

## 示例

-   简单表单校验：

```js
import { Api, Yes } from 'befly';
const fields = { email: '邮箱 ⚡string⚡5⚡100⚡null⚡1⚡^.+@.+$' };
export default Api.POST('订阅', false, fields, ['email'], async (befly, ctx) => Yes('ok'));
```

-   curl：

```
curl -X POST http://127.0.0.1:3000/api/app/sub/subscribe -H "Content-Type: application/json" -d "{\"email\":\"a@b.com\"}"
```
