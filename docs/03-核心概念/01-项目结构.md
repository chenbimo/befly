# 项目结构与启动流程

本章带你理解 Befly 如何启动：检查 -> 插件 -> 路由 -> 监听。

## 启动主线（core/main.js）

Befly.listen() 内部主要步骤：

1. initCheck()

-   扫描 `core/checks/*.js`（排除以 `_` 开头），调用具名导出且以 `check` 开头的函数。
-   统计通过/失败数量；如有失败，直接 `process.exit()`。

2. loadPlugins()

-   扫描核心插件目录 `core/plugins/*.js` 与用户插件目录 `app/plugins/*.js`（实际由 `getProjectDir('plugins')` 解析到 `tpl/plugins`）。
-   通过 `after` 指定依赖顺序，排序后执行 `onInit(appContext)`。
-   初始化结果挂载到 `appContext[pluginName]`，例如 `db`、`logger`、`redis`。
-   如有导入/初始化失败，统一退出进程。

3. loadApis('core'|'app')

-   扫描 `core/apis/**/*` 与 `<project>/apis/**/*`，忽略包含 `_` 的路径。
-   验证接口定义（name/auth/fields/required/handler），并注册路由为：
    `api.route = "<METHOD>/api/<core|app>/<相对路径>"`。

4. Bun.serve()

-   绑定 `routes`：
    -   `/`：欢迎/健康信息
    -   `/api/*`：统一 API 分发
    -   `/*`：静态文件（来自 `<project>/public`）
-   统一的 CORS、日志、JWT 解析、参数校验流程。

## 接口定义（Api.GET/POST）

-   位置：`<project>/apis/**/xxx.js`
-   形态：
    ```js
    export default Api.POST(
        '显示名',
        true /* 或 false|['admin','user'] */,
        {
            /* 字段规则 */
        },
        [
            /* 必填字段数组 */
        ],
        async (befly, ctx, req) => {
            /* handler */
        }
    );
    ```
-   route 自动生成：`METHOD + /api/<core|app>/<相对路径>`。
-   ctx：headers/body/user。

## RYes / RNo 响应

-   成功：`RYes(message, data)` → `{ code:0, msg: message, data }`
-   失败：`RNo(message, error?)` → `{ code:-1, msg: message, error? }`

## 插件示例：数据库（core/plugins/db.js）

-   读取 `Env.DB_*`，当 `DB_ENABLE===1` 时通过 `createSqlClient()` 创建连接池，构造 `SqlManager` 实例，挂载为 `befly.db`。
-   失败会清理连接并抛出，由主流程统一退出。

## 参数校验与保留字段

-   规则在接口文件内通过 `fields` 定义；`required` 指定必填。
-   校验器 `utils/validate.js` 在进入 handler 前执行。
-   保留字段：`id, created_at, updated_at, deleted_at, state` 禁止在自定义规则中使用。

## 静态文件

-   路由 `/*` 从 `<project>/public` 目录读文件返回，自动带上 content-type 与 CORS。
