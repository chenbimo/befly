# 请求到响应流程

本文梳理一次完整的请求在 Befly 内部的生命周期（参见 `core/main.js`）。

## 总览

1. 进入 `/api/*`
2. 组装上下文 ctx：headers、body、user
3. CORS 预检（OPTIONS）直返 204
4. 路由匹配 `METHOD + /api/<core|app>/<path>`
5. JWT 解析（Authorization: Bearer <token>）→ `ctx.user`
6. GET/POST 参数解析与按 fields 裁剪
7. 插件 `onGet` 钩子依次执行
8. 访问日志（字段过滤）
9. 权限校验（auth：true|role|string[]）
10. 参数校验（validator）
11. 执行 handler，返回 `RYes/RNo` 或原始 Response
12. 错误捕获与统一 500

## 关键节点

-   CORS：`utils/index.setCorsOptions()` 计算头；所有返回均带上。
-   JWT：`utils/jwt.verify()` 解析，失败则 `ctx.user = {}`。
-   参数解析：
    -   GET：`url.searchParams`
    -   POST：content-type 自动识别 json/xml/form/form-urlencoded
-   参数裁剪：`pickFields` 仅保留在 `fields` 中声明的键。
-   日志：结构化输出，敏感字段由 `Env.LOG_EXCLUDE_FIELDS` 过滤。
-   校验与必填：`utils/validate.js`，失败返回 `{ code:-1, msg:'无效的请求参数格式', fields }`。
-   错误统一：catch 后 `RNo('内部服务器错误')`。
