# Befly Framework - AI Coding Agent Instructions

## 项目概述

Befly 是专为 Bun 运行时设计的 API 框架，采用插件化架构，提供数据库操作、身份验证、日志记录等核心功能。

## 核心架构模式

### 插件系统

- **插件位置**: `plugins/` 目录包含核心插件，用户项目可扩展
- **插件依赖**: 使用 `after: ['plugin_name']` 定义加载顺序
- **插件结构**: 导出包含 `onInit()` 方法的对象，接收 `befly` 实例
- **示例**: `plugins/db.js` 管理数据库连接池和查询构造器

### API 路由定义

- **位置**: `apis/` 目录按功能模块组织
- **格式**: 使用 `Api.GET()` 或 `Api.POST()` 定义路由
- **参数**: `(name, auth, fields, required, handler)`
- **示例**: `apis/health/info.js` 展示健康检查接口

### 数据验证系统

- **规则定义**: `tables/*.json` 文件定义字段验证规则
- **格式**: `"字段名": "显示名⚡类型⚡最小值⚡最大值⚡默认值⚡是否索引⚡正则约束"`
- **分隔符**: 使用 `⚡` 作为属性分隔符，避免与正则表达式中的管道符 `|` 冲突
- **保留字段**: 避免使用 `id`, `created_at`, `updated_at`, `deleted_at`, `state`
- **验证器**: `utils/validate.js` 处理参数验证逻辑
- **枚举支持**: 使用正则表达式实现枚举，如 `^(active|inactive|pending)$`

## 开发工作流

### 运行时要求

- **使用 Bun**: 优先使用 `bun` 进行安装、测试等操作，避免使用 `node`/`npm`/`npx`
- **测试文件管理**: 所有测试文件必须放在 `tests/` 目录下，且只能包含 `.test.js` 后缀的文件
- **测试目录纯净**: `tests/` 目录中不允许存在非 `.test.js` 的文件，包括临时文件、辅助文件等
- **临时文件清理**: 临时测试文件测试完毕后必须立即删除
- **代码复用**: 尽可能复用现有代码，保持逻辑高效且简洁

### 命令行工具

- **CLI**: `befly <script-name>` 执行框架脚本
- **优先级**: 检测 Bun 环境，回退到 Node.js
- **脚本位置**: `scripts/` 目录

### 版本发布

```bash
bun run ra  # 主版本 (major)
bun run rb  # 次版本 (minor)
bun run rc  # 补丁版本 (patch)
```

### 测试运行

```bash
bun test                    # 运行所有测试
bun test tests/jwt.test.js  # 运行特定测试
```

## 项目特定约定

### 路径管理

- **系统路径**: `system.js` 定义框架和项目路径常量
- **使用模式**: 导入 `__dirroot`, `__dirscript` 等预定义路径
- **项目区分**: 框架路径 vs 用户项目路径分离

### 数据库操作

- **查询构造器**: `utils/curd.js` 的 `SqlBuilder` 类
- **字段转义**: 自动处理 MySQL 字段名转义（反引号）
- **连接管理**: 插件系统管理连接池生命周期

### 环境配置

- **配置中心**: `config/env.js` 统一管理环境变量
- **类型转换**: 自动处理数字类型配置项
- **功能开关**: `MYSQL_ENABLE`, `REDIS_ENABLE` 等开关配置

### 日志记录

- **工具类**: `utils/logger.js` 提供结构化日志
- **字段过滤**: 支持敏感字段排除记录
- **多输出**: 控制台和文件双重输出

## 关键集成点

### 数据库连接

- **MariaDB**: 使用 `mariadb` 包，动态导入避免启动依赖
- **连接池**: 配置重连、超时、保活等生产级参数
- **测试连接**: 启动时验证数据库连接状态

### Redis 缓存

- **可选组件**: 通过 `REDIS_ENABLE` 控制启用状态
- **健康检查**: `apis/health/info.js` 包含连接状态检测

### 系统检查

- **启动检查**: `checks/` 目录包含系统自检脚本
- **表定义检查**: 验证表结构定义合规性
- **性能监控**: 记录检查执行时间

## 常见模式

### 错误处理

- 使用 `RYes(message, data)` 返回成功响应
- 使用 `RNo(message, error)` 返回失败响应
- 统一错误日志记录格式

### 中间件模式

- 插件通过 `onInit` 钩子注册功能
- 支持异步初始化和依赖注入
- 统一的生命周期管理

### 配置驱动

- 功能模块通过环境变量控制启用/禁用
- 支持开发和生产环境差异化配置
- 动态功能加载避免不必要的依赖
